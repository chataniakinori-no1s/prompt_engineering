---
seq: 8
title: サンプル課題
slug: chapter01/work06
description: ユーザーの入力に応じた条件分岐を実装し、AIの応答を最適化する方法を学ぶ
type: work
difficulty: 3
displayLanguage: ja
duration: 10
---

# 条件分岐による対話制御とコスト最適化

:::sample-quiz
## サンプル課題
前回のワークで作成したチャットボットは、登録された文書（ナレッジベース）の中からその質問に最も関連性の高い部分を検索して、回答生成することが可能になりました。
しかし、塚本さんが実際に運用してみると、新たな課題として「コスト」の側面が見えてきました。

> **【新たな依頼：管理部 塚本さん】**
> 「FAQボットが対応してくれて助かります！ただ分析してみると、社員が単に『ありがとう』とお礼を言っただけの時も、AIが一生懸命に社内文書全体を検索しているようなんです。これは無駄なコスト（トークン）がかかっていますよね？
> 雑談や挨拶の時はナレッジ検索をせず、本当に情報が必要な時だけ検索するようにできませんか？」

## 1. 条件分岐の基本を理解する

Difyでは、ユーザーの入力内容に応じて処理を分岐させることができます。これにより、以下のような制御が可能です：

- 挨拶やお礼には定型文で応答
- 簡単な質問には事前に登録したFAQから回答
- 複雑な質問のみナレッジベースを検索

## 2. 条件分岐を実装する

1. **新しいアプリケーションの作成**
   - Difyで新しいアプリケーションを作成し、「チャットアプリ」を選択します。

2. **条件分岐ノードの追加**
   - ワークフローに「条件分岐」ノードを追加します。
   - 条件式を設定し、ユーザーの入力内容を判定します。

3. **条件に応じた処理の分岐**
   - 条件に一致する場合と一致しない場合の処理をそれぞれ設定します。
   - 挨拶やお礼には定型文を返すように設定します。
   - 質問の場合のみ、ナレッジベースを検索するように設定します。

4. **RAG回答LLMノードの設定**:
   - `コンテキスト` に `知識取得` ノードの `result` を設定します。
   - `ユーザー入力` に `sys.query` を設定します。
   - `メモリ` 機能をONにします。
   - 前回と同様の「制約条件」を持つシステムプロンプトを設定します。

## 3. コスト最適化のポイント

1. **トークン使用量の削減**
   - 不要な検索を避けることで、トークン使用量を削減できます。
   - 特に、大規模なナレッジベースを検索する際のコストを抑えられます。

2. **レスポンスタイムの短縮**
   - 単純な応答は即座に返すことで、ユーザーエクスペリエンスを向上させます。
   - 複雑な質問にのみ、時間をかけて検索・生成を行います。

3. **メモリの最適化**
   - 会話の流れを保持するメモリのサイズを最適化します。
   - 不要な情報は定期的にクリアする仕組みを導入します。

## 4. テストと調整

1. **テストケースの作成**
   - 様々なパターンの入力を用意し、適切に分岐するか確認します。
   - 特に境界条件（例：挨拶と質問が混在する入力）のテストが重要です。

2. **パフォーマンスの計測**
   - 応答時間、トークン使用量、APIコール回数などを計測します。
   - ボトルネックを特定し、必要に応じて調整します。

3. **ユーザーフィードバックの収集**
   - 実際のユーザーからのフィードバックを収集し、改善に役立てます。
   - 特に、誤って分岐してしまったケースを重点的に分析します。

## 5. まとめ

このワークでは、条件分岐を活用してAIチャットボットの効率を向上させる方法を学びました。ユーザーの入力に応じて適切な処理を選択することで、コストを削減しつつ、ユーザーエクスペリエンスを向上させることができます。

次回は、さらに高度な機能を実装して、より実践的なAIアシスタントを作成していきましょう。
