---
seq: 18
title: 実践課題
slug: chapter03/work14
description: 複雑な指示を安定して実行するための3つのテクニックを学び、問題解決AIアシスタントを構築する
type: work
difficulty: 3
displayLanguage: ja
duration: 25
relation: chapter03/index
---

# 複雑な指示を安定させる、問題解決AIアシスタント

**【今回のクライアント課題：社員食堂責任者 坂田さんのお悩み】**
「最近、社員食堂の評判が良くないという噂を耳にした…。**チャットで社員の不満点を受け取ったらいい感じに返答しておき、AIが問題の種類に応じて適切な専門家に相談して私への提言をまとめ、その内容をスプレッドシートに記録してくれる**、そんな仕組みがあれば、迅速な対応と状況の可視化ができて助かるのだが…。」

**概要**:
Work1では、エージェントを制御するための2つの基本的なアプローチを学びました。このワークでは、より実践的な課題解決に挑戦します。
食堂責任者の坂田さんの「社員の不満点を分析し、専門家に相談、スプレッドシートに記録した上で、社員に返信する」という複数のステップを含む複雑な要求は、一つのエージェントノードにすべて処理させると、モデルが指示を誤解し、エラーを引き起こす可能性があります。
ここでは、そのような複雑な指示を安定して実行させるための、3つのテクニック（**指示の単純化、モデルの性能向上、ツールの見直し**）を学びます。


## 実践：社員の不満を解決し、記録する問題解決エージェントを構築しよう

それでは、実際にDifyを操作して、坂田さんの課題を解決するエージェントを構築していきます。

### Step 1: 事前準備 - プラグインとツールのインストール

1.  **推論戦略プラグインのインストール**:
    * Difyのトップページ上部にある `[プラグイン]` をクリックします。
    * 検索窓に「`Dify Agent Strategies`」と入力し、表示されたプラグインをインストールします。
2.  **Google Sheetツールのインストール**:
    * 同様に `[ツール]` → `[マーケットプレイス]` を選択します。
    * `google_sheets` を検索し、`追加` ボタンをクリックしてインストールします。（必要に応じてGoogleアカウントでの認証設定を行ってください）

### Step 1.5: Google Sheetsの認証設定 - サービスアカウントキーの取得

Google SheetsツールをDifyから利用するには、Google Cloud Platform (GCP) で「サービスアカウント」を作成し、その認証情報（JSONキー）を設定する必要があります。少し手順が多いですが、一度設定すれば様々なアプリケーションで活用できるので、挑戦してみましょう。

1.  **Google Cloud Platform (GCP) へアクセス**:
    * Googleアカウントで[Google Cloud Console](https://console.cloud.google.com/)にログインします。
2.  **新しいプロジェクトの作成**:
    * 画面上部のプロジェクト選択メニューから `[新しいプロジェクト]` を作成します。（プロジェクト名は「Dify Integration」など分かりやすいものにしましょう）
3.  **Google Sheets APIの有効化**:
    * 作成したプロジェクトを選択した状態で、ナビゲーションメニューから `[APIとサービス]` → `[ライブラリ]` を選択します。
    * 検索窓で「`Google Sheets API`」を検索し、`[有効にする]` ボタンをクリックします。
4.  **サービスアカウントの作成**:
    * ナビゲーションメニューから `[APIとサービス]` → `[認証情報]` を選択します。
    * `[+ 認証情報を作成]` → `[サービスアカウント]` をクリックします。
    * サービスアカウント名（例: `dify-sheets-agent`）を入力し、`[作成して続行]` をクリックします。
    * 「ロールを選択」では、「編集者」のロールを付与し、`[続行]` → `[完了]` をクリックします。
5.  **JSONキーの生成とダウンロード**:
    * 作成したサービスアカウントの一覧が表示されるので、今作成したアカウントのメールアドレスをクリックします。
    * `[キー]` タブを選択し、`[鍵を追加]` → `[新しい鍵を作成]` をクリックします。
    * キーのタイプとして `JSON` を選択し、`[作成]` をクリックすると、認証情報が記載されたJSONファイルが自動的にダウンロードされます。**このファイルは非常に重要なので、大切に保管してください。**
6.  **Googleスプレッドシートの共有設定**:
    * Difyで記録用に使いたいGoogleスプレッドシートを開きます。
    * 右上の `[共有]` ボタンをクリックします。
    * 共有相手として、Step 5で作成されたサービスアカウントのメールアドレス（`...@...iam.gserviceaccount.com`という形式）を追加し、権限を「編集者」に設定して共有します。
7.  **Difyへの認証情報設定**:
    * Difyの `[ツール]` -> `[Google Sheets]` を選択し、認証設定画面を開きます。
	* 認証名はご自由に入力してください。
    * ダウンロードしたJSONファイルの中身（テキスト全文）をコピーし、Difyの認証情報欄に貼り付けて認証を行います。
	
以上で、DifyからGoogle Sheetsを操作する準備が整いました。

### Step 2: 専門家（カスタムツール）の準備

エージェントに与える「道具」として、調理師・栄養士・総務の役割を担う3つのワークフローを作成します。

1.  **調理師ワークフローの作成**:
    * アプリタイプ`[ワークフロー]`で「調理師アシスタント」を作成します。
    * `開始`ノードで フィールドタイプ`段落`、変数名`complaint`、最大長`500`で変数を定義します。
   　* `LLM`ノードを追加し、以下のシステムプロンプトを設定します。

```
# ペルソナ
あなたは、5つ星ホテルのレストランで総料理長を10年務めた経験を持つ、ベテランの調理師です。味に対するプライドと、お客様を満足させることへの情熱を持っています。

# 背景
私たちの社員食堂で、ある社員から以下の不満の声が届きました。

# 指示
この不満を解決するため、以下の思考プロセスに従って、プロフェッショナルな改善策を食堂責任者へ提案してください。
1.  **原因分析**: まず、この不満の根本的な原因が何であるかを、調理のプロセスの観点（食材、調理法、温度管理など）から推測してください。
2.  **具体的改善策の立案**: 次に、特定した原因を解決するための、明日からでも実行可能な具体的な改善策を立案してください。
3.  **期待される効果**: 最後に、その改善策によって社員の満足度がどのように向上するかを説明してください。

# 出力形式
## 【原因分析】
（ここに分析を記述）

## 【具体的な改善策】
（ここに改善策を記述）

## 【期待される効果】
（ここに効果を記述）
```

	* ユーザープロンプトを設定します。

```
#社員の不満の声
{{#開始.complaint#}}
```

2.  **栄養士ワークフローの作成**:
    * 同様に「栄養士アシスタント」を作成します。
    * `開始`ノードで フィールドタイプ`段落`、変数名`complaint`、最大長`500`で変数を定義します。
    * `LLM`ノードを追加し、以下のシステムプロンプトを設定します。

```markdown

# ペルソナ
あなたは、企業の健康経営を支援する経験豊富な管理栄養士です。社員の健康を第一に考え、科学的根拠に基づいた的確なアドバイスを得意としています。

# 背景
私たちの社員食堂のメニューについて、ある社員から健康面に関する以下の不満の声が届きました。

# 指示
この不満の表面的な部分だけを見るのではなく、一歩引いた視点（ステップバック）で、社員食堂全体の栄養戦略における根本的な課題は何かを考察してください。その上で、社員の健康増進に繋がる、科学的根拠に基づいた改善策を食堂責任者へ提案してください。

# 出力形式
## 【栄養学的観点からの課題分析】
（ここに課題分析を記述）

## 【具体的な改善提案】
（ここに改善提案を記述）

## 【提案の根拠と期待効果】
（なぜこの提案が有効なのか、その根拠と期待できる効果を記述）

```

	* ユーザープロンプトを設定します。

```markdown
#社員の不満の声
{{#開始.complaint#}}
```

	3.  **総務ワークフローの作成**:
    * 同様に「総務アシスタント」を作成します。
    * `開始`ノードで フィールドタイプ`段落`、変数名`complaint`、最大長`500`で変数を定義します。
    * `LLM`ノードを追加し、以下のシステムプロンプトを設定します。

```markdown
# ペルソナ
あなたは、社員食堂の運営を長年担当してきた、現実的でコスト意識の高い総務部のマネージャーです。

# 背景
社員食堂の運営や設備について、以下の不満の声が届きました。

# 指示
この問題を解決するための、実現可能な改善策を食堂責任者へ提案してください。
ただし、提案と同時に、その施策を実行する上での潜在的なリスクや課題（自己検証）も正直に併記してください。

# 出力形式
## 【問題点の整理】
（ここに問題点の要約を記述）

## 【実現可能な解決策】
（ここに解決策を記述）

## 【導入時の考慮点（リスク・課題）】
（ここに考慮点を記述）
```

	* ユーザープロンプトを設定します。

```
#社員の不満の声
{{#開始.complaint#}}
```

### Step 2.5: ワークフローをツールとして公開する

作成した3つのワークフローをエージェントノードでツールとして利用可能にするため、公開設定を行います。

1.  作成した各ワークフロー（「調理師アシスタント」など）の開発画面右上の**`[公開]`ボタン**を押して、**`[更新を公開する]`ボタン**を押します。
2.  その下にある**`「ワークフローをツールとして公開する」`ボタン**を押して、ツールとしての設定を行います。
    * **アイコンと名前**: AIや自分が識別しやすいように設定します。
    * **ツールコールの名前**: 機械認識に使用される名前を設定します。例えば栄養士なら`nutritionist`と入力します。
    * **ツールの説明**: AIがいつこのツールを使うべきか判断するための項目です。「料理の味や品質に関する問題の専門家」のように、役割を具体的に記述します。
    * **ツール入力**: ここに表示される項目（`complaint`など）は、ワークフローの`開始`ノードで設定した入力フィールドに対応します。
    * **メソッド**: 入力フィールドに値を渡す方法を定義します。
        * **LLM入力**: エージェント（LLM）が、文脈に応じて動的に値を生成して渡します。
        * **設定**: 人間が事前に固定の値を設定しておきます。
    * 今回は、エージェントが社員の不満点を解析し、その内容を各専門家に渡す必要があるため、`complaint`という項目のメソッドは**`LLM入力`**に設定します。
3.  この設定を3つのワークフローすべてに対して行います。

### Step 3: 安定性を高めるためのエージェント設計

いよいよエージェントノードを使ったチャットフローを構築します。
坂田さんの要望である「①受付→②分析→③相談→④記録→⑤報告」は、複数のステップを含む複雑な指示です。これを**単一のエージェントノードで実行させようとすると、モデルの推論負荷が高まり、`json invalid error`や`PluginInvokeError`といったエラーが発生しやすくなります。**

そこで、このワークでは複雑な指示を安定して実行させるための3つの重要なテクニック、**「指示の単純化（ノード分割）」「モデルの性能向上」「ツールの見直し（Codeツールの活用）」**を学びながら、エージェントを構築していきます。


### **テクニック1：指示の単純化（ノードの分割）**

最も効果的な安定化手法は、一つのエージェントに複雑なタスクを全て任せるのではなく、**役割ごとにエージェントを分割**することです。これにより、各エージェントが受け持つ指示が単純になり、モデルは混乱することなく、より確実にタスクを実行できます。

今回は、フローを大きく2つの役割に分割します。
1.  **問題分析・解決役**: 社員と対話し、問題を分析し、適切な専門家に解決策を諮問する。
2.  **記録・報告役**: 解決策をGoogle Sheetsに記録し、社員への最終的な返信を作成する。

---

1.  新しい**チャットフロー**を作成し、「食堂改善コンサルタント」と名付けます。

### **【前半部】エージェントノード1（問題分析・解決役）**

2.  キャンバスに**エージェントノード**を一つ配置します。
3.  エージェントノードの設定パネルを開き、以下を設定します。
    * **Agent Strategy**: `Function Calling` を選択します。
    * **Tools List**: `[+ 追加]` ボタンから、Step2で作成した3つのワークフロー（調理師、栄養士、総務）を追加します。
4.  **Instruction**に、以下のプロンプトをコピー＆ペーストしてください。このエージェントは「専門家への相談と提言の入手」までが役割です。
    ```
    # 役割
    あなたは、社員食堂の評判を改善する任務を負った、優秀な問題解決コンサルタントです。

    # 目標
    社員からの食堂に関する具体的な不満点をヒアリングし、適切な専門家に相談して、食堂責任者への提言内容を導き出すことがあなたの使命です。

    # 行動指針
    以下の思考プロセスを厳密に遵守してください。
    1.  **受付**: まず、社員の不満を受け止め、共感する言葉を返してください。
    2.  **問題分析**: 不満の内容を注意深く読み解き、問題が「品質」「健康」「運営」のどれに分類されるかを特定します。
    3.  **専門家への相談**: 上記専門家チームの中から、その問題を深堀するのに最もふさわしい専門家へ相談し、責任者への提言内容を入手します。
    4.  **出力**: 最終的に、後続のプロセスで利用するために、「元の不満の声」と専門家から得られた「提言内容」の両方を明確に出力してください。
    ```

### **【後半部】エージェントノード2（記録・報告役）**

5.  もうひとつ**エージェントノード**を配置して、先ほどのエージェントノード1と接続します。


### **テクニック2：モデルの性能向上**& **テクニック3：ツールの見直し（Codeツールの活用）**

後半の記録パートでは、Google Sheetsが要求する厳格なJSON形式にデータを整形する必要があります。このような**形式が決まっているデータ変換は、LLMに直接生成させるよりも、Codeツール（Code Interpreter）に任せた方が遥かに確実**であり、`json invalid error`を未然に防ぐことができます。
また、複数のツールを使いこなし、複雑なデータ形式を扱うためには、より高度な推論能力を持つモデルの選択が推奨されます。

---

6.  新たに設置したエージェントノード2の設定パネルを開き、以下を設定します。
    * **モデルの選択**: ここでは、より複雑な指示を正確に理解できる **Gemini 2.5 Pro**を選択します。Flashモデルでエラーが発生する場合でも、モデルの性能を上げることで安定性が向上します。
    * **Agent Strategy**: `Function Calling` を選択します。
    * **Tools List**: `[+ 追加]` ボタンから、`Google Sheets`ツールと`Code Interpreter`ツールを追加します。
        * `Google Sheets`の設定画面を開き、Step 1.5で認証したAPIキーを選択し、反映先の`Spreadsheet ID`を設定します。
7.  **Instruction**に、以下のプロンプトをコピー＆ペーストしてください。
    ```
    # 役割
    あなたは、受け取ったテキストを処理し、Googleスプレッドシートに記録する自動化エージェントです。

    # 目標
    提供されたテキストに含まれる「社員の声」と「提言内容」を抽出し、Googleスプレッドシートの末尾に追記してください。

    # 行動指針
    以下のステップを厳密に実行してください。

    **ステップ1: Codeツールによるデータ整形**
    まず、`Code Interpreter`ツールを使い、提供されたテキストから「社員の声」と「提言内容」を抽出し、Google Sheetsツールが要求するJSON形式に整形してください。
    求めているjson形式: [{"range":"シート1!A1", "values":[["社員の声", "提言内容"]]}]

    **ステップ2: Google Sheetsツールによる記録**
    次に、ステップ1で`Code Interpreter`が出力したJSON文字列を`data`パラメータに設定し、`Google Sheets`ツールの`append`機能を呼び出して、シートの末尾に行を追記してください。
    ```
8.  最後に`回答`ノードを追加し、**一つ目のエージェントノード**の出力テキスト（社員への返信部分）を表示するように接続します。

### Step 4: テストと実行

設定が正しく機能するか試してみましょう。

1.  チャット画面で、様々な種類の不満点を入力してみます。
    * **(例1: 調理師向け)**「今日の唐揚げが冷めてて美味しくなかったです。」
    * **(例2: 栄養士向け)**「最近、揚げ物が多くて胃がもたれます。もっとヘルシーなメニューを増やしてほしいです。」
    * **(例3: 総務向け)**「食券機のお金の反応が悪くて、急いでいる時に困ります。」
2.  エージェント1が専門家を呼び出し、エージェント2がCodeツールでデータを整形した上でGoogle Sheetsに記録していることをログで確認します。
3.  最終的に、専門家の意見に基づく提言を含んだ丁寧な返信が生成されれば成功です！

### **トラブルシューティング：エージェントが期待通りに動作しない場合**

`json invalid error`や`PluginInvokeError: KeyError`といったエラーが発生する場合、それはモデルがInstructionプロンプトの指示通りに推論・出力できていない可能性を示唆しています。その際の基本的な対処法は2つあります。

1.  **指示の単純化（ノードの分割）**:
    一つのエージェントノードに多数のステップ（今回の場合5ステップ）を詰め込むと、モデルの推論負荷が高まり、混乱を招くことがあります。その場合、エージェントの役割を分割するアプローチが有効です。
    * **エージェントノード1（問題分析・解決役）**: 不満点を受け取り、専門家に相談して解決策を得る、というステップ3までの役割に特化させます。
    * **エージェントノード2（記録・報告役）**: エージェント1の出力を受け取り、スプレッドシートへの記録と最終報告を行う、ステップ4と5の役割に特化させます。
    このように、一つの複雑な指示を、二つの単純な指示に分解することで、各エージェントの動作が安定し、結果として全体の信頼性が向上します。

2.  **モデルの性能向上**:
    複雑な指示を正確に理解し、複数のツールを適切に使い分ける能力は、LLMの推論性能に大きく依存します。
    * **Gemini 2.5 Flash**: 速度とコスト効率に優れていますが、複雑なタスクでは指示の解釈を誤ることがあります。
    * **Gemini 2.5 Pro**: より高度な推論能力を持っており、複雑で長文のInstructionプロンプトでも、より忠実に実行する能力が期待できます。
    プロンプトを改善してもエラーが解消しない場合は、エージェントノードのモデルをFlashからProに切り替えることで、推論精度が向上し、問題が解決することもあります。

3.  **ツールの見直しと代替案の検討**:
    問題の原因が、モデルの推論能力ではなく、**ツール自体の設計**にある可能性も考慮します。
    * **ツールの説明文は明確か？**: AIはツールの説明文を頼りにその役割を理解します。説明が曖昧だと、AIはツールを誤用する可能性があります。「〇〇するための専門家」のように、役割を具体的に記述することが重要です。
    * **入力パラメータは複雑すぎないか？**: ツールが要求する入力パラメータが複雑なJSON形式などである場合、LLMがそれを正しく生成するのに失敗している可能性があります。エージェントノードに渡す前にコーディングツールで整形することも有効な手段です。
    * **よりシンプルな代替ツールは存在しないか？**: Difyのマーケットプレイスを探索し、同じ目的を達成できる、よりシンプルでLLMが扱いやすいツールが存在しないか検討してみましょう。

### **このプロンプトのアプローチは？**

今回エージェントに与えたInstructionプロンプトは、**「逐次的アプローチ」**です。「行動指針」の中で、「1.受付→2.分析→3.相談→4.記録→5.報告」という具体的な処理の**手順(How)**を明確に指示しているからです。このように手順を指定することで、AIの思考プロセスを厳密にコントロールし、毎回安定した品質のアウトプットを生成させることができます。ビジネスの定型業務など、プロセスの遵守が重要な場面で非常に有効なアプローチです。

お疲れ様でした！ これであなたは、エージェントノードの基本概念をマスターし、複数の専門家（ツール）を協調させて一つの高度な目標を達成させる、という複雑なタスクをプロンプト一つで実現することができました。
次は、この講座における最後の実践課題です。生成AIプロンプトエンジニアリング講座で学んできたスキルを惜しみなく発揮し、GrowthTech代表取締役のお悩み解決に挑戦してみましょう。

