---
seq: 15
title: 実践課題
slug: chapter02/work12
description: 実践的な課題を通じて、自己改善ループを搭載したSEO記事自動生成ワークフローを構築する
type: practice
difficulty: 3
displayLanguage: ja
duration: 60
relation: chapter02/work11
---

# 【実践課題】自己改善ループを搭載したSEO記事自動生成ワークフローを実装しよう！

この章で学んだ知識とスキルを総動員して、最後の課題に挑戦しましょう。これまでのワークで段階的に構築してきたパイプラインを参考に、提示された課題を解決する完全自動化ワークフローを、あなた自身の力でゼロから構築していただきます。

## 今回のお悩み：広報マーケティング部 堂本さん

「コンテンツマーケティングの一環で、SEOに強いブログ記事を量産しないといけないんだ。でも、毎回キーワードと文字数だけ指定されて、そこから検索上位の競合サイトを分析し、読者の検索意図を汲み取った構成案を考え、質の高い記事を執筆するのは本当に骨が折れる作業で…。この一連のリサーチから執筆までのプロセスを自動化して、自分はもっと戦略的な業務に集中したいんだが…。」

あなたのタスクは、AIコンサルタントとして堂本さんの悩みを解決することです。これまでの章で習得した高度なプロンプトスキルとDifyのワークフロー開発スキルを駆使し、「キーワード」「文字数」「ターゲット」「ゴール」を記載した**メモファイル（.txt）**をインプットするだけで、競合分析から記事の推敲、そして最終的なWord(DOCX)ドキュメントの出力までを全自動で行うワークフローを開発してください。

### 実装すべき必須要件

* **開始**: アップロードされた**メモファイル（.txt）**の内容を後続のLLMに渡せるようテキスト化すること。
* **調査**: **メモファイル（.txt）**のキーワードを1つの文字列につなげてWeb検索ツールで1度だけ検索し、検索上位5サイトの記事タイトル、ディスクリプション、記事内容を取得し、その傾向を分析すること。
* **分析**: 調査結果と元の**メモファイル（.txt）**を基に、SEOで上位表示を狙うための最適な記事構成案（タイトル案、見出し構成、含めるべきトピックなど）を具体的に作成すること。
* **品質向上**: ループノードを活用し、「執筆→レビュー」のフィードバックループを実装すること。プロの編集者の視点を持つLLMからの指摘がなくなるまで、記事の推敲を自動で繰り返す仕組みを構築してください。
* **出力**: 最終的に完成したマークダウン形式の記事を、Word (DOCX) 形式のドキュメントファイルに変換して出力すること。

### Hint 💡

* この課題の鍵は、2〜5章で学んだプロンプトスキルと、7章で学んだLLMチェーンの組み合わせです。「リサーチ戦略立案（ステップバック思考）」「分析と構成案作成」「記事執筆（Few-Shot）」「記事レビュー（メタ認知）」といったように、各LLMに明確な役割と適切なプロンプトを与えましょう。
* 品質の向上のためにはループノードが不可欠です。「レビューLLMの出力に特定の文字列（例：指摘事項なし）が含まれる」ことをループの終了条件に設定するのがポイントです。
* この課題ではTavily SearchやMarkdown to DOCX Converterツールが必須です。[ツール]メニューからマーケットプレイスを開き、忘れずに追加しておきましょう。（Tavily Searchには別途APIキーが必要です）
* 各ノードの出力を、次のノードの入力として正しく変数で受け渡すことが、パイプラインを正常に動作させるための最も重要なポイントです。

健闘を祈ります！

---

# 【解答例】実装の流れ

以下に、この課題を解決するためのワークフローの実装手順の一例を示します。自分の力で挑戦した後に、答え合わせとして確認してください。

### Step 1: ツールの準備（既にインストール済みの方はStep2へ）

1.  Dify画面上部のメニューから `ツール` → `マーケットプレイス` を選択します。
2.  `Tavily Search & Extract` と `Markdown to DOCX Converter` を検索し、それぞれ `追加` ボタンをクリックしてインストールします。
3.  ツールタブでTavily Searchの認証情報（APIキー）を設定します。

### Step 2: 開始ノードとテキスト抽出

1.  Difyで新しいワークフローを作成します。（例: `SEO記事自動生成フロー`）
2.  開始ノードをクリックし、ファイルアップロード用の変数を追加します。
    * **変数名**: `requirements_doc`, **ラベル名**: `記事のメモファイル`, **タイプ**: `単一ファイル`, **必須**: `ON`
3.  開始ノードの次に `テキスト抽出` ノードを追加し、ファイル変数 `{{#開始.requirements_doc#}}` を設定します。

### Step 3: 検索キーワードの抽出 (LLM #1)

1.  `テキスト抽出`ノードの次にLLMノードを追加します。
2.  このLLMに「SEOアナリスト」の役割を与え、メモファイルから最も重要な検索キーワードを3つ抽出させます。
    * **【プロンプト設計のポイント】**
        後続のTavily Searchノードに正確なキーワードを渡すため、このLLMのタスクを「キーワード抽出」だけに絞り込みます。**役割設定**と**制約条件**を明確にすることで、AIの出力をコントロールし、パイプライン全体を安定させます。
    * **【プロンプト実例】**
```prompt
# 役割
あなたは、文章から検索エンジンで使われるべき最も重要なキーワードを見つけ出す専門のSEOアナリストです。

# 指示
以下の記事作成メモから、この記事の核となる検索キーワードを3つだけ抽出してスペース区切りで出力してください。

# 制約条件
- 出力はキーワードの文字列のみとします。
- 説明や前後の文章は一切含めないでください。
- **完全な自然言語の文章ではなく、検索エンジンに最適化された3個程度の重要なキーワードの組み合わせをスペース区切りで生成してください。**
- **出力は検索クエリの文字列のみ**とし、マークダウンや説明文など余計な情報は絶対に含めないでください。

## 期待する出力形式例:
生成AI　ビジネス活用　業務効率化
```
3.  ユーザー入力に `テキスト抽出` ノードの出力 `{{#テキスト抽出.text#}}` を設定します。

### Step 4: Web検索の実行 (Tavily Search)

1.  LLM #1の次に`Tavily Search`ノードを追加します。
2.  **【解説】**
    堂本さんの要件にあった通り、今回は複数のキーワードをスペースで区切った**単一の文字列**で一度だけ検索を行います。そのため、前回のワークで学んだ**イテレーションノードは不要**になり、ワークフローがよりシンプルになります。
3.  `Tavily Search` の入力変数 `Query` に、Step 3のLLMが出力した文字列 `{{#LLM（キーワード抽出）.text#}}` を直接設定します。

### Step 5: 配列の整形 (コード)

1.  `Tavily Search`ノードの次に、`コード実行`ノードを追加します。
2.  **【解説】**
    Tavily Searchから出力された検索結果のリスト（配列）は、そのままでは後続のLLMが扱いにくいデータ形式です。このコードノードで、LLMが読みやすい**単一のテキスト（文字列）**に変換します。イテレーションを使わないため、ネスト配列を解除する処理が不要になり、コードもシンプルになります。
3.  入力変数 `search_results` に `{{#Tavily Search.results#}}` を設定し、出力変数 `final_search_results` を `String` 型として設定します。
4.  以下のPythonコードを貼り付けます。

```python
import json

def main(search_results: list) -> dict:
    """
    Tavily Searchから出力された検索結果の配列（リスト）を、
    LLMが読みやすいマークダウン形式の単一の文字列に変換する。
    """
    if not search_results:
        return {"final_search_results": "関連する検索結果は見つかりませんでした。"}

    formatted_string_chunks = []
    # イテレーションの出力ではないので、入力はすでにフラットなリストになっている
    for i, result in enumerate(search_results):
        # .get()を使い、キーが存在しない場合でもエラーを防ぐ
        title = result.get('title', 'タイトルなし')
        url = result.get('url', 'URLなし')
        content = result.get('content', '内容なし')
        score = result.get('score', 0)

        # 各検索結果をマークダウン形式のテキストブロックに整形
        chunk = (
            f"## 検索結果 {i+1}\n\n"
            f"### タイトル: {title}\n"
            f"**URL:**{url}\n"
            f"**関連スコア:**{score:.4f}\n\n"
            f"**内容:**\n{content}\n"
        )
        formatted_string_chunks.append(chunk)

    # 全てのテキストブロックを区切り線で結合して、最終的な単一の文字列を作成
    final_string = "\n---\n\n".join(formatted_string_chunks)
    
    return {"final_search_results": final_string}
```

### Step 6: 競合分析と構成案作成 (LLM #2)

1.  `コード実行（配列の整形）`ノードの次に、2つ目のLLMノードを追加します。
2.  このLLMに「コンテンツプランナー」の役割を与え、整形された検索結果と元のメモファイルを基に、SEOに最適化された記事の構成案を作成させます。
    * **【プロンプト設計のポイント】**
        ここでは複雑な分析と創造的な作業が求められるため、第3章で学んだ**Chain of Thought（段階的思考）**を活用します。「まず〜、次に〜、最後に〜」のように思考のステップを指示することで、AIは論理的にタスクを分解し、最終的な出力の質を大幅に向上させることができます。
    * **【プロンプト実例】**
```prompt
# 役割
あなたは、読者の検索意図を深く理解し、SEOで上位表示される記事構成を作成するプロのコンテンツプランナーです。

# 背景
提供された「記事の要件」と「Web検索の結果」を基に、これから作成するブログ記事の最適な構成案を作成します。

# 指示
以下の思考プロセスに従って、最高の記事構成案を出力してください。
1.  **競合分析**: まず、「Web検索の結果」を精査し、検索上位のサイトが共通して取り上げているトピック、読者が求めているであろう情報（検索意図）、そしてユニークな切り口を特定してください。
2.  **要件との統合**: 次に、競合分析の結果と元の「記事の要件」を統合し、この記事が競合よりも優位に立つための戦略を立ててください。
3.  **構成案作成**: 最後に、上記すべてを踏まえ、以下の出力形式に従って具体的な記事構成案を作成してください。

# 出力形式
## タイトル案（3つ）
- 
- 
- 

## 記事の構成案
### H2:（見出し）
#### H3:（小見出し）
- （この見出しで触れるべき内容の要約）
### H2:（見出し）
#### H3:（小見出し）
- （この見出しで触れるべき内容の要約）
```
3.  ユーザー入力に、元のメモファイル `{{#テキスト抽出.text#}}` と、整形された検索結果 `{{#コード実行（配列の整形）.final_search_results#}}` の両方を設定します。

### Step 7: ループによる品質向上

1.  構成案作成LLMの次に`ループ`ノードを追加します。
2.  ループノードを以下のように設定します。
    * **ループ変数**: `draft_article` (String), `review_comments` (String) を空文字("")で初期化。
    * **ループ終了条件**: ループ内のレビューLLMの出力 `{{#LLM（レビュー）.text#}}` が `指摘事項なし` を `含む`。
3.  ループノードの中に、LLMノードを2つ（執筆用とレビュー用）と、`変数代入`ノードを追加します。

### Step 8: 記事の執筆・修正 (LLM #3 @ループ内)

1.  ループ内の1つ目のLLMに「プロのWebライター」の役割を与えます。
    * **【プロンプト設計のポイント】**
        AIが生成する文章のトーン＆マナーを統一するため、第3章で学んだ**Few-Shot（少数例示）**テクニックが有効です。理想的な文体を短い例として示すことで、AIはそれを模倣し、よりブランドイメージに合った記事を執筆してくれます。
    * **【プロンプト実例】**
```prompt
# 役割
あなたは、指定された構成案に基づき、読者のエンゲージメントを高める専門的かつ分かりやすい文章を書くプロのWebライターです。

# 指示
提供された「記事の構成案」と「記事作成メモ」を基に、ブログ記事を執筆してください。
「前回のレビュー指摘事項」がある場合は、その内容をすべて反映して文章を修正してください。

# 文体の例 (Few-Shot)
私たちのメディアでは、以下のような読者に寄り添う親しみやすい文体を理想としています。このスタイルを参考にしてください。
（悪い例）: 人工知能は、機械学習の一分野であり、データのパターンを認識する能力を有する。
（良い例）: AIって聞くと難しく感じるかもしれませんが、実は「データの中から法則を見つけるのが得意な賢いアシスタント」のようなものなんです。

# 制約条件
- マークダウン形式で執筆してください。
- 「記事作成メモ」で指定された文字数を意識してください。
```
2.  ユーザー入力に以下の3つを設定します。
    * **記事の構成案**: `{{#LLM（構成案作成）.text#}}`
    * **記事作成メモ**: `{{#テキスト抽出.text#}}`
    * **前回のレビュー指摘事項**: `{{#ループ.review_comments#}}` (ループ変数)

### Step 9: 記事のレビュー (LLM #4 @ループ内)

1.  ループ内の2つ目のLLMに「ベテラン編集長」の役割を与えます。
    * **【プロンプト設計のポイント】**
        AIに自己評価させることで品質を向上させる、第5章で学んだ**メタ認知プロンプト**を活用します。具体的な評価基準を与えることで、AIは多角的な視点から記事をレビューし、質の高いフィードバックを生成します。ループを正しく終了させるための指示も重要です。
    * **【プロンプト実例】**
```prompt
# 役割
あなたは、SEO、読者の満足度、文章の論理構成の観点から記事を厳しく評価するベテラン編集長です。

# 指示
以下の「記事作成メモ」と、それに基づいて作成された「記事ドラフト」をレビューしてください。
以下のレビュー観点に基づき、具体的で建設的な改善点を最大3つ、箇条書きで指摘してください。
**もし改善点が一切なければ、必ず「指摘事項なし」とだけ出力してください。**この応答がループを終了させるトリガーになります。

# レビュー観点
- **SEO要件**: 記事作成メモにあるキーワードは、不自然にならない範囲で効果的に使われているか？
- **読者満足度**: ターゲット読者の疑問に答え、ゴールを達成できる内容になっているか？
- **論理構成と明確性**: 文章は読みやすく、主張は明確で一貫しているか？
```
2.  ユーザー入力に、元のメモファイル `{{#テキスト抽出.text#}}` と執筆LLMの出力 `{{#LLM（執筆）.text#}}` を設定します。

### Step 10: ループ変数の更新 (変数代入 @ループ内)

1.  レビューLLMの次に`変数代入`ノードを追加します。
2.  `draft_article` を `{{#LLM（執筆）.text#}}` で、`review_comments` を `{{#LLM（レビュー）.text#}}` で上書きします。

### Step 11: Word (DOCX) ドキュメントへの変換

1.  ループノードの外側に、`Markdown to DOCX Converter`ノードを追加します。
2.  ノードを以下のように設定します。
    * **markdown_text (入力)**: ループ変数 `{{#ループ.draft_article#}}`
    * **file_name (出力ファイル名)**: `AI出力記事`
3.  `Markdown to DOCX Converter`ノードを終了ノードに接続し、出力を設定します。

### Step 12: 最終確認

1.  プレビュー画面で記事の**メモファイル（.txt）**をアップロードして実行します。
2.  処理完了後、出力欄からDOCXファイルをダウンロードし、内容が推敲されたSEO記事になっていることを確認すれば、課題完了です。