---
seq: 27
title: ワーク1: 思考の深化（ステップバック）- 問題の本質を見抜く
slug: chapter05/work1
description: 問題の本質を見極め、より深い分析と解決策を導くためのステップバックテクニックを学ぶ
type: work
relation: chapter05/index
difficulty: 3
displayLanguage: ja
duration: 25
---

# ワーク1: 思考の深化（ステップバック）- 問題の本質を見抜く

## サンプル課題
システムエンジニアの高橋さんの元に、プロダクトマネージャーの田中さんが少し慌てた様子でやってきました。

> **田中さんのお悩み:**
> 「高橋さん、緊急の相談だ。君が実装してくれたリアルタイム翻訳機能、大好評なんだけど、その影響で特定のエンドポイント(`/api/v1/translate`)のレスポンスが極端に悪化しているらしい。サポートチームには『最近、翻訳がすごく遅い』というクレームが殺到していて、このままでは大問題になりかねない。何とかして、このAPIを速くしてくれないか？」

> **高橋さんの思考:**
> 「そうだったんですね…。アクセス急増が原因だとは思いますが、単純にサーバーを増強するだけだと、コストもかさむし、根本的な解決にならないかもしれません。下手にいじって、別のバグを生むのも避けたい。場当たり的な対応ではなく、きちんと原因を特定して、最適な改善策を打ちたいのですが…。」

このような、複雑で根本的な問題の分析にこそ、AIの思考を深く導く「ステップバック」の技術が役立ちます。AIと共に、問題の核心に迫りましょう。

## 解説

### AIに「そもそも」を考えさせるステップバック思考

私たちは問題に直面すると、すぐに「どう解決するか？(How)」を考えがちです。しかし、より重要なのは「なぜこの問題が起きているのか？(Why)」や「そもそも何を達成すべきなのか？(What)」を問うことです。

**ステップバック**とは、このようにAIとの対話において、あえて一歩引いた視点から、問題の前提や本質、根本原因を考えさせるプロンプト技術です。

- **表面的な解決策から脱却できる**: 「〇〇するには？」と聞く代わりに、「そもそも、なぜ〇〇が必要なのか？」と問うことで、より本質的な解決策の発見に繋がります。
- **問題の解像度を高める**: 複雑な問題を複数の視点から分解・分析させ、これまで気づかなかった論点を発見できます。
- **戦略的な意思決定を支援する**: 目先の課題だけでなく、長期的なゴールやビジョンに立ち返って思考を促すことで、より大局的な判断が可能になります。

成功の鍵は、AIに安易に答えを求めず、**思考の出発点そのものを問い直す**ような、質の高い質問を投げかけることです。

### サンプル課題解答

**【シチュエーション】**
田中さんから「APIを速くしてほしい」という依頼を受けた高橋さん。彼は、いきなりコードの修正に取り掛かるのではなく、まずは問題の全体像を把握するため、一歩引いてAIに問いかけることにしました。

**▼ プロンプト例**
```
あなたは、Webアプリケーションのパフォーマンスチューニングを専門とする、経験豊富なSRE（Site Reliability Engineer）です。

現在、私が担当するサービスで、特定のAPIエンドポイント(`/api/v1/translate`)のレスポンスが極端に悪化し、問題となっています。

この問題の根本原因を特定するため、考えられる技術的な要因を体系的に洗い出したいです。
パフォーマンス劣化の原因となりうる要素を、以下の3つのレイヤーに分類し、それぞれ具体的な可能性を複数挙げてください。

# 分析のレイヤー
1.  アプリケーションレイヤー
2.  データベースレイヤー
3.  インフラストラクチャーレイヤー
```

**▼ AIによる出力例**
```
承知いたしました。SREとして、APIパフォーマンス劣化の潜在的な原因をレイヤーごとに分析します。

### 1. アプリケーションレイヤーでの可能性
- **N+1クエリ問題**: ループ処理の中で、都度データベースへのクエリが発行されており、APIコール一回あたりに大量のSQLが実行されている可能性があります。
- **非効率なアルゴリズム**: 特定のデータ処理や計算に、計算量の多いアルゴリズムが使用されており、CPUリソースを過剰に消費している可能性があります。
- **メモリリーク**: アプリケーションがメモリを適切に解放できておらず、実行時間が長くなるにつれてパフォーマンスが徐々に悪化している可能性があります。
- **外部APIコールの遅延**: 翻訳処理のために呼び出している外部API（例: DeepL API）からの応答が遅い、あるいはタイムアウトが頻発している可能性があります。

### 2. データベースレイヤーでの可能性
- **インデックスの不足・不備**: クエリの実行計画（Execution Plan）が非効率になっており、テーブルのフルスキャンが発生している可能性があります。
- **ロック競合**: 特定のテーブルや行に対して更新処理が集中し、トランザクションの待機時間が長くなっている可能性があります。
- **コネクションプールの枯渇**: アプリケーションからの接続要求に対し、データベースのコネクションプールが不足し、接続待ちが発生している可能性があります。

### 3. インフラストラクチャーレイヤーでの可能性
- **リソース不足**: サーバーのCPU、メモリ、ディスクI/Oなどが、現在のアクセス負荷に対して単純に不足している可能性があります。
- **ネットワーク帯域の飽和**: サーバー間の通信や、外部へのAPIコールにおいて、ネットワーク帯行が上限に達している可能性があります。
- **不適切なスケーリング設定**: オートスケーリングの設定が不適切で、負荷の急増にサーバーリソースの増強が追いついていない可能性があります。
```

---
### 練習問題1

**【シチュエーション】**
AIが提示した網羅的な原因リストを見て、高橋さんは思考の整理ができました。彼は、このAPIが翻訳履歴を保存するために、複数のテーブルを結合して読み込んでいることから、特に「データベースレイヤー」が怪しいと睨んでいます。しかし、データベースのどこから手をつければ良いか、具体的な調査手順を明確にしたいと考えています。

さあ、実際にChatGPTやGeminiなどの対話AIを使い、**データベースのパフォーマンス問題を特定するための、具体的な診断手順をAIに作成させる**プロンプトを作成してみましょう。

### Hint
ここでもステップバックの考え方が役立ちます。「データベースを速くする方法を教えて」と聞くのではなく、**「データベースの問題を診断するための『手順書』や『チェックリスト』を作って」**と依頼するのです。これにより、AIは場当たり的なアイデアではなく、構造化された体系的なアプローチを提示してくれます。プロンプトでは、AIに**「経験豊富なデータベース管理者（DBA）」**の役割を与え、**「新人エンジニアでも手順通りに進められるような、分かりやすい診断フロー」**の作成を依頼すると、より実践的なアウトプットが期待できます。

**▼ プロンプト例**
```
ありがとうございます。原因の全体像が把握できました。
特に「データベースレイヤー」に問題がある可能性が高いと考えています。

あなたは、大規模サービスのデータベース管理経験が豊富な、シニアデータベース管理者（DBA）です。
データベースに起因するAPIのパフォーマンス問題を診断するための、具体的な調査チェックリストを作成してください。
私がこのチェックリストに沿って調査を進められるよう、各項目で何を確認すべきか、簡単な説明も加えてください。
```

**▼ AIによる出力例**
```
承知いたしました。シニアDBAとして、データベースパフォーマンスの診断チェックリストを作成します。この手順で進めてみてください。

### データベースパフォーマンス診断チェックリスト

**□ 1. スロークエリログの確認**
- **確認内容**: まず、データベースのスロークエリログを有効化し、問題のAPIが実行しているクエリの中に、実行時間が極端に長いものが記録されていないかを確認します。これが最も直接的なボトルネックの発見方法です。

**□ 2. 実行計画（Execution Plan）の分析**
- **確認内容**: スロークエリが見つかったら、そのクエリの実行計画を`EXPLAIN`コマンドなどで確認します。`type`が`ALL`（フルスキャン）になっていないか、`key`（使用インデックス）が`NULL`になっていないかなど、非効率なデータアクセスが行われていないかをチェックします。

**□ 3. インデックスの妥当性確認**
- **確認内容**: `WHERE`句や`JOIN`句で使われているカラムに、適切にインデックスが設定されているかを確認します。複合インデックスが必要なケースや、逆に不要なインデックスがクエリのパフォーマンスを下げているケースもあります。

**□ 4. N+1クエリの検出**
- **確認内容**: アプリケーションのログや、APM（Application Performance Management）ツールを使い、問題のAPIリクエスト一回あたりに、類似の`SELECT`クエリが大量に発行されていないかを確認します。これが「N+1クエリ」の兆候です。

**□ 5. テーブルのロック状況の監視**
- **確認内容**: `SHOW PROCESSLIST`などのコマンドで、特定のクエリが長時間`Locked`状態になっていないかを確認します。更新処理と参照処理が競合し、パフォーマンスが劣化している可能性があります。
```

---
### 練習問題2

**【シチュエーション】**
AIが作成したチェックリストに従って調査を進めた結果、高橋さんは、**「N+1クエリ」**がパフォーマンス劣化の直接的な原因であることを突き止めました。彼はこの技術的な問題を、プロダクトマネージャーの田中さんに説明し、修正作業の工数を確保してもらう必要があります。しかし、田中さんはエンジニアではないため、「N+1クエリ」と言っても伝わりません。

さあ、実際にChatGPTやGeminiなどの対話AIを使い、**この複雑な技術的問題を、非エンジニアにも分かりやすく説明するための「たとえ話」をAIに作成させる**プロンプトを作成してみましょう。

### Hint
ここでもステップバック思考が有効です。「N+1クエリとは何か？」と技術的な説明を求めるのではなく、**「そもそも、この問題の何がそんなに悪いのか？」という本質**を、誰もが共感できるストーリーに置き換えさせるのです。AIに**「技術的な内容を、小学生にも分かるように説明するのが得意なベテラン教師」**のような役割を与え、「N+1クエリ問題」を、例えば**「図書館での本の探し方」**や**「レストランでの注文の仕方」**といった、身近なシチュエーションに例えて説明させてみましょう。これにより、技術的な詳細ではなく、問題の「非効率さ」という本質が直感的に伝わるようになります。

**▼ プロンプト例**
```
原因が特定できました。「N+1クエリ」という問題のようです。
この技術的な問題を、非エンジニアであるプロダクトマネージャーにも理解してもらう必要があります。

あなたは、難しい技術的な概念を、身近なたとえ話を使って説明するのが非常に得意な、ベテランのITコンサルタントです。
「N+1クエリ」問題が、なぜパフォーマンスを悪化させるのか、その本質が直感的に理解できるような、分かりやすいたとえ話を作成してください。
```

**▼ AIによる出力例**
```
承知いたしました。「N+1クエリ」問題の、たとえ話ですね。プロダクトマネージャーの方には、このように説明すると分かりやすいでしょう。

---
**【たとえ話：スーパーマーケットでの非効率な買い物】**

田中さん、今からスーパーで10個の商品を買うと想像してみてください。

**普通の買い物（効率的な方法）**は、こうですよね。
1.  買うものリスト（10個）を手に取る。
2.  一度だけ店内に入り、リストを見ながら10個の商品をすべてカートに入れる。
3.  一度だけレジに並び、まとめて会計する。

これが、システムが本来あるべき効率的なデータの取り方です。

一方で、**「N+1クエリ」問題が起きているシステム**は、こんな信じられないくらい非効率な買い物をしています。

1.  まず、1回目の買い物として店内に入り、「ニンジンを1本ください」とだけ言ってレジで会計し、一度店の外に出ます。
2.  次に、2回目の買い物として再び店内に入り、「タマネギを1個ください」と言って会計し、また外に出ます。
3.  これを、10個の商品すべてに対して、**合計11回（最初の1回＋商品10個分）も店への出入りと会計を繰り返す**のです。

これでは、ものすごく時間がかかってしまいますよね。
今、私たちのAPIで起きているのは、まさにこの「非効率な買い物」と同じ状態なのです。私の仕事は、このバラバラな買い物を、本来あるべき「一度の買い物」に修正することです。
```

---
お疲れ様でした。これでワーク1は終了です。
次のワークでは、ここで見出した問題の本質を基に、具体的なリニューアル戦略をAIに立案させる方法について学んでいきましょう。
