---
seq: 53
title: 問題の本質を見抜く
slug: chapter05/work47
description: 問題の本質を見極めるためのテクニック
type: exercise
relation: chapter05/work01
difficulty: 2
displayLanguage: ja
duration: 15
---
# 問題の本質を見抜く
## 📝 練習問題

:::exercise
**【シチュエーション】**
AIが提示した網羅的な原因リストを見て、高橋さんは思考の整理ができました。彼は、このAPIが翻訳履歴を保存するために、複数のテーブルを結合して読み込んでいることから、特に「データベースレイヤー」が怪しいと睨んでいます。しかし、データベースのどこから手をつければ良いか、具体的な調査手順を明確にしたいと考えています。

さあ、実際にChatGPTやGeminiなどの対話AIを使い、**データベースのパフォーマンス問題を特定するための、具体的な診断手順をAIに作成させる**プロンプトを作成してみましょう。
:::

:::hint
ここでもステップバックの考え方が役立ちます。「データベースを速くする方法を教えて」と聞くのではなく、**「データベースの問題を診断するための『手順書』や『チェックリスト』を作って」**と依頼するのです。これにより、AIは場当たり的なアイデアではなく、構造化された体系的なアプローチを提示してくれます。プロンプトでは、AIに**「経験豊富なデータベース管理者（DBA）」**の役割を与え、**「新人エンジニアでも手順通りに進められるような、分かりやすい診断フロー」**の作成を依頼すると、より実践的なアウトプットが期待できます。
:::

<details><summary>練習問題プロンプト例</summary>

```
ありがとうございます。原因の全体像が把握できました。
特に「データベースレイヤー」に問題がある可能性が高いと考えています。

あなたは、大規模サービスのデータベース管理経験が豊富な、シニアデータベース管理者（DBA）です。
データベースに起因するAPIのパフォーマンス問題を診断するための、具体的な調査チェックリストを作成してください。
私がこのチェックリストに沿って調査を進められるよう、各項目で何を確認すべきか、簡単な説明も加えてください。
```

**▼ AIによる出力例**
```
承知いたしました。シニアDBAとして、データベースパフォーマンスの診断チェックリストを作成します。この手順で進めてみてください。

### データベースパフォーマンス診断チェックリスト

**□ 1. スロークエリログの確認**
- **確認内容**: まず、データベースのスロークエリログを有効化し、問題のAPIが実行しているクエリの中に、実行時間が極端に長いものが記録されていないかを確認します。これが最も直接的なボトルネックの発見方法です。

**□ 2. 実行計画（Execution Plan）の分析**
- **確認内容**: スロークエリが見つかったら、そのクエリの実行計画を`EXPLAIN`コマンドなどで確認します。`type`が`ALL`（フルスキャン）になっていないか、`key`（使用インデックス）が`NULL`になっていないかなど、非効率なデータアクセスが行われていないかをチェックします。

**□ 3. インデックスの妥当性確認**
- **確認内容**: `WHERE`句や`JOIN`句で使われているカラムに、適切にインデックスが設定されているかを確認します。複合インデックスが必要なケースや、逆に不要なインデックスがクエリのパフォーマンスを下げているケースもあります。

**□ 4. N+1クエリの検出**
- **確認内容**: アプリケーションのログや、APM（Application Performance Management）ツールを使い、問題のAPIリクエスト一回あたりに、類似の`SELECT`クエリが大量に発行されていないかを確認します。これが「N+1クエリ」の兆候です。

**□ 5. テーブルのロック状況の監視**
- **確認内容**: `SHOW PROCESSLIST`などのコマンドで、特定のクエリが長時間`Locked`状態になっていないかを確認します。更新処理と参照処理が競合し、パフォーマンスが劣化している可能性があります。
```
</details>

