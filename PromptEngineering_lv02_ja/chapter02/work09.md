---
seq: 17
title: ワークフローの仕組みと基本操作
slug: chapter02/work09
description: ワークフローの基本的な仕組みを理解し、API設計書の雛形ジェネレーターを作成する
type: work
difficulty: 2
displayLanguage: ja
duration: 20
relation: chapter02/index
---

# ワークフローの仕組みと基本操作

この章からは、一度の指示で複数の処理を最後まで一気通貫で自動実行する「**ワークフロー**」の構築に挑戦します。まずは、この章で私たちが解決すべき課題を見ていきましょう。

:::sample-quiz
> **【今回のクライアント課題：システムエンジニア 高橋さんのお悩み】**
> 「プロダクトマネージャーから渡される機能要件定義書をもとに、毎回APIの仕様やデータベースのテーブル設計を考えるのは時間がかかる。特に、似たような機能の実装例をWebで調査し、それを設計書に落とし込む定型的な作業を自動化して、もっとクリエイティブな設計作業に集中したいんだが…。」
:::

さて、この高橋さんの課題、前章で学んだ「チャットフロー」で解決できるでしょうか？

チャットフローは、ユーザーとの対話を通じて処理を進めるのには非常に優れています。しかし、高橋さんの悩みは「要件定義書をインプットしたら、設計書がアウトプットされる」という、途中で対話が不要な一連の定型作業です。

このような課題を解決するために、この章では**一括実行型（バッチ処理型）**のアプリケーションである「**ワークフロー**」を学びます。

この最初のワークでは、高橋さんの壮大な自動化の第一歩として、まずワークフローの基本的な仕組みを理解します。ごくシンプルな「API設計書の雛形ジェネレーター」を作成する演習を通じて、自動化処理の核心である「トリガー」と「パイプライン」の概念を理解していきましょう。


## ワークフローの基本を理解しよう

アプリケーション作成を始める前に、ワークフローの基本的な考え方を学びましょう。

### チャットフローとの違い

前章で学んだチャットフローは、ユーザーとAIが会話のキャッチボールをしながら処理を進める**対話型**のアプリケーションでした。

一方、この章で学ぶワークフローは、最初に必要な情報をフォームなどで一度だけ入力すれば、あとは人間が介在することなく、決められた処理が最後まで自動で実行される**一括実行型（バッチ処理型）**のアプリケーションです。

まさに高橋さんの課題のように、途中で対話が不要な定型業務の自動化には、このワークフローが非常に適しています。

## 自動化処理の構成要素：トリガーとパイプライン

「トリガー」と「パイプライン」は、ワークフローだけでなく、チャットフローにも共通する自動化の基本概念です。皆さんは前章で、すでにこれらの概念を無意識のうちに体験しています。ここでは、両者の違いを明確にしながら、その役割を深く理解しましょう。

* **トリガー (きっかけ)**
    処理全体を開始させる「きっかけ」のことです。
    * **チャットフローの場合**: **ユーザーが送信する一つ一つのメッセージ**がトリガーです。会話のターンごとにトリガーが引かれ、処理が実行されます。
    * **ワークフローの場合**: ユーザーが**最初に一度だけフォームに入力し、実行ボタンを押すこと**がトリガーです。この一度のきっかけで、全ての処理が最後まで実行されます。

* **パイプライン (処理の流れ)**
    トリガーによって開始された後、データがノードからノードへと受け渡されながら実行される、一連の処理の流れ全体を指します。
    * **チャットフローの場合**: ユーザーのメッセージを処理し、応答を返すまでの一連の流れがパイプラインです。このパイプラインが、会話のターンごとに繰り返し実行されます。
    * **ワークフローの場合**: 開始ノードから終了ノードまでの全ての処理が、一つの巨大なパイプラインです。このパイプラインは、一度の実行で完結します。


## 実践：初めてのワークフローを動かしてみよう

それでは、実際にDifyを操作して、最初のワークフローを作っていきます。目標は、「機能名」と「機能の概要」を入力すると、簡単なAPI設計書の雛形（JSON形式）を自動生成するワークフローです。

### Step 1: 新しいワークフローの作成

1.  Difyのトップページから `[アプリを作成]` をクリックします。
2.  `[最初から作成]` を選択します。
3.  アプリタイプとして `[ワークフロー]` を選びます。
4.  アプリ名に「API設計書ジェネレーター」と入力し、`[作成]` ボタンを押します。

すると、`開始` のノードだけが配置された、シンプルな開発画面が表示されます。

### Step 2: 開始ノード（トリガー）を設定する

まず、ワークフローを起動するきっかけ（トリガー）となる、ユーザー入力用のフォームを定義します。

1.  `開始` ノードをクリックして、設定パネルを開きます。
2.  `[+ 変数を追加]` をクリックして、ユーザー入力用の変数を2つ作成します。
    * **フィールドタイプ**: `短文`, **変数名**: `feature_name`, **ラベル名**: `機能名` 
    * **フィールドタイプ**: `段落`, **変数名**: `description`, **ラベル名**: `機能概要`
3.  `フィールド名` は、実際にユーザーが見るフォームの項目名になります。`必須` のチェックボックスをONにしておきましょう。

これで、ワークフローを実行するための入力フォームが定義できました。

### Step 3: LLMノードを追加・設定する

次に入力された情報をもとに、設計書の雛形を生成するAIの処理をパイプラインに組み込みます。

1.  `開始` ノードに表示されている `+` ボタンをクリックします。
2.  `[LLM]` を選択し、新しいLLMノードを追加します。
3.  追加した `LLM` ノードをクリックし、モデルを `Gemini` モデルに設定します。
4.  `システムプロンプト` に、以下の文章をコピー＆ペーストしてください。これまで学んだ**役割設定**、**背景**、**少数例示（Few-Shot）**などの形式を活用しています。
    ```
    # 役割
    あなたは、経験豊富で優秀なシステムアーキテクトです。
    RESTful APIの設計原則を深く理解しており、渡された要件から最適なAPI仕様を導き出すことを得意としています。

    # 背景
    現在、開発チームでは機能要件定義書からAPI設計書を書き起こす作業に多くの時間がかかっています。
    このワークフローの目的は、その定型的な作業を自動化し、エンジニアがより創造的な作業に集中できる環境を作ることです。

    # 指示
    以下のユーザー入力に基づいて、RESTful APIの設計書の雛形をJSON形式で生成してください。

    ### 制約
    - エンドポイントのパスは、機能名から推測される適切なものを設定してください。（例: /users, /products）
    - HTTPメソッドは、機能概要から最も適切と思われるものを"GET", "POST", "PUT", "DELETE"の中から選択してください。
    - レスポンスの例として、成功時(200 OK)のシンプルなJSONボディを必ず含めてください。
    - 出力はJSONオブジェクトのみとし、前後の説明文は一切含めないでください。
    ```
5.  `+メッセージ追加`ボタンをクリックし、`USER` の欄に、以下のように入力します。`/` を入力すると変数の候補が表示されるので、`開始.feature_name` と `開始.description` を選択してください。
    ```
    機能名: {{#start.feature_name#}}
    機能概要: {{#start.description#}}
    ```
    これで、開始ノードで入力された2つの変数が、LLMへの指示文（ユーザー入力）として動的に組み込まれます。

### Step 4: 終了ノードに接続する

最後に、LLMが生成した結果をワークフローの最終出力として設定します。

1.  `LLM` ノードに表示されている `+` ボタンをクリックします。
2.  `終了` を選択し、新しい終了ノードを追加します。
3.  `終了` ノードをクリックします。
4.  `[+ 出力変数を追加]` をクリックし、`LLM` ノードの出力（`LLM.text`）を選択します。
5.  変数名を `api_design_json` のように分かりやすく変更しておきましょう。

### Step 5: テストと実行

設定が正しく機能するか、実行機能を使って試してみましょう。

1.  画面右上の `[実行]` ボタンを押すと、Step2で定義した入力フォームが表示されます。
2.  `機能名` に「ユーザー情報取得」、`機能概要` に「指定されたIDのユーザー情報を1件取得する」と入力して、`[実行開始]` ボタンを押します。
3.  左側の開発画面で、`開始` → `LLM` → `終了` の順にノードが光り、処理がパイプラインを流れていく様子がわかります。
4.  右側の出力欄に、JSON形式でAPI設計書の雛形が表示されれば成功です！

お疲れ様でした！ これで、あなたはDifyのワークフローの基本概念をマスターし、一括実行型の自動化アプリケーションの原型を作り上げることができました。

この基本を元に次のワークでは、Web検索やドキュメント連携といった、より実践的なツールを組み込んで、高橋さんの課題解決に本格的に取り組んでいきます。
