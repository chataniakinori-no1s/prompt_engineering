#### ワーク3: RAG（検索拡張生成）でAIを賢くしよう

Work2では、Difyの基本的な操作を学び、AIに特定の役割を与えるチャットボットを作成しました。しかし、そのAIはあなたの会社のルールや、特定の業務マニュアルの内容までは知りません。このままでは、冒頭の塚本さんの課題「社内情報に詳しいFAQボットが欲しい」を解決することはできません。

この課題を解決する鍵が、**RAG（Retrieval-Augmented Generation：検索拡張生成）**という技術です。このワークでは、RAGの仕組みを学び、Difyを使って社内文書の内容を正確に回答できるAIチャットボットを構築します。

---

### RAG（検索拡張生成）とは？

#### なぜRAGが注目されているのか

ChatGPTのような一般的なLLMは、事前に学習した膨大なデータをもとに回答しますが、**学習データに含まれない情報（最新のニュースや、あなたの会社独自のルールなど）は知りません**。

これまで、この制約に対処するために「プロンプトに参考情報をすべて貼り付ける」という方法がありましたが、これには以下のような問題がありました。
* 毎回ファイルをアップロードするのは手間がかかる。
* プロンプトが長くなり、利用コストが増大する。
* LLMが一度に処理できる文字数（トークン数）には上限がある。

**RAG**は、これらの問題を解決する画期的な技術です。事前に社内文書などをシステムに登録しておき、ユーザーの質問に応じて**関連する部分だけをAIが参照して回答を生成する**仕組みです。 これにより、コストを抑えつつ、膨大な独自情報に基づいた正確な回答が可能になります。

#### RAGの基本的な仕組み

RAGの仕組みは、実は私たちの情報検索プロセスとよく似ています。知らないことを質問されたとき、私たちは参考資料やGoogleで関連情報を探し、その情報をもとに回答を組み立てますよね。RAGも同様に、以下の2ステップで動作します。

1.  **検索 (Retrieval)**: ユーザーの質問が来たら、まず事前に登録された文書（ナレッジベース）の中から、その質問に最も関連性の高い部分を検索して探し出します。
2.  **生成 (Generation)**: 見つけ出した関連情報と元の質問をLLMに渡し、「この情報に基づいて回答してください」と指示を出して、最終的な回答を生成させます。

この「必要な部分だけを賢く検索して利用する」という点がRAGの核心です。

#### DifyがRAGを簡単にする理由

RAGの裏側では、「埋め込みモデル」による文章の数値化や、「ベクトル検索」といった高度な技術が動いています。 本来、これらを一から実装するのは専門知識が必要で非常に大変ですが、Difyはこれらの複雑な技術をパッケージ化し、**プログラミング不要**で誰でも簡単にRAGアプリケーションを構築できるようにしてくれます。

---

### 実践：育児休業規定に詳しいFAQボットを作る

> **【今回のお悩み：管理部 塚本さん】**
> 「育児休業の規定について、いろいろな社員から細かい質問を何度も受けていて、本来の業務が進まないんです…。『育児休業規定_サンプル.docx』というマニュアルはあるのですが、みんな読んでくれなくて。このPDFの内容を正確に参照して、私の代わりに質問に答えてくれるチャットボットが作れないでしょうか？」

それでは、実際にDifyを使い、塚本さんの悩みを解決するRAGチャットボットを作成していきましょう。

#### Step 1: ナレッジの準備とアップロード

まず、AIに参照させたい「育児休業規定_サンプル.docx」をDifyに「ナレッジ」として登録します。

1.  Difyのトップメニューから `[ナレッジ]` を選択します。
2.  `[ナレッジを作成]` ボタンをクリックします。
3.  `[ファイルのアップロード]` を選択し、AIに学習させたい文書ファイル（例：`育児休業規定_サンプル.docx`）をアップロードします。
4.  `[次へ]` をクリックします。

#### Step 2: テキストの前処理設定

次に、アップロードした文書をAIが検索しやすいように「前処理」します。まずはデフォルト設定のまま進めましょう。

1.  **チャンク処理**: `汎用` が選択されていることを確認します。
2.  **インデックスモード**: `高品質` を選択します。 これにより、文章の意味を理解して検索する「ベクトル検索」の準備が行われます。
3.  `[保存して処理]` をクリックします。処理が完了し、ステータスが「利用可能」になるまで少し待ちます。

これで、AIが文書を検索するための準備が整いました。

#### Step 3: チャットフローの構築とノード設定

次に、RAGの処理フローをチャットフローで組み立てます。

1.  `[スタジオ]` に戻り、`[アプリを作成]` から `[チャットフロー]` を選択し、新しいアプリ（例: `育児休業規定ボット`）を作成します。
2.  今回は1から作るので、デフォルトで配置されている `LLM` ノードと `回答` ノードは一度削除してください。
3.  `開始` ノードの `+` ボタンを押し、`[知識取得]` ノードを追加します。このノードがRAGの「検索」部分を担当します。
4.  **知識取得ノードの設定**:
    * ノードをクリックし、`クエリ変数` に `sys.query` を設定します。これは「ユーザーの質問を手がかりに検索する」という意味です。
    * `ナレッジ` の欄で、先ほど作成したナレッジ（`育児休業規定_サンプル.docx`）を選択します。

5.  `知識取得` ノードの `+` ボタンを押し、`[LLM]` ノードを追加します。これが「生成」部分を担当します。
6.  **LLMノードの設定**:
    * `コンテキスト` の設定欄をクリックし、`知識取得` ノードの出力である `result` を選択します。 これで、検索結果をLLMに渡す準備ができました。
    * **`メモリ` のトグルスイッチをONにします。** これにより、AIは過去の会話を記憶し、「それについてもっと詳しく」といった追跡質問にも対応できるようになります。
    * `システムプロンプト` に、以下のプロンプトを貼り付けます。
        ```
        あなたはGrowthTech社の管理部アシスタントAIです。
        提供された育児休業規定の文書にのみ基づいて、社員からの質問に対し、正確かつ丁寧な言葉遣いで回答してください。

        ### 制約条件
        - 必ず文脈の情報のみを使用して回答すること
        - 文脈に含まれない情報については「規定文書をご確認いただくか、管理部までお問い合わせください」と回答すること
        - 推測や一般的な知識での補完は行わないこと

        ### 文脈
        {{context}}
        ```
    * `ユーザー入力` の欄に、`sys.query` を設定します。これで、ユーザーの質問もLLMに渡されます。

7.  `LLM` ノードの `+` ボタンを押し、最後に `[回答]` ノードを追加します。
8.  **回答ノードの設定**: `回答`ノードをクリックし、設定パネルを開きます。`入力`欄で、前の`LLM`ノードの出力変数（例: `{{#LLM-1.result#}}`）が設定されていることを確認します。

#### Step 4: 動作確認

すべてのノードが繋がったら、プレビュー画面で動作を確認しましょう。

1.  画面右上の `[プレビュー]` をクリックします。
2.  チャット入力欄に、PDFの内容に関する質問をしてみてください。
    * **あなた**: `育児休業は何歳まで取得できますか？`
    * **AIの応答（予想）**: （PDFの内容に基づき）`お子様が1歳に達するまで取得できます。`
3.  続けて、文脈に依存した質問をしてみましょう。
    * **あなた**: `男性も取れますか？`
    * **AIの応答（予想）**: （メモリ機能が働き、育休の話題と理解して）`はい、男性社員も取得可能です。`

ナレッジの内容に基づいてAIが回答し、追跡質問にも答えられれば成功です！

---

お疲れ様でした！ これで、あなただけの知識を持ったAIチャットボットが完成しました。次のWork4では、このチャットボットの課題点を改善する実践的なテクニックを学びます。

---

### 【小コラム1】RAGの心臓部を探る：AIはどのようにして"賢く"検索しているのか？

Work3では、Difyの「知識取得」ノードを使って、驚くほど簡単にRAG（検索拡張生成）アプリケーションを構築できることを体験しました。しかし、ナレッジを作成する際に何気なくクリックした「前処理設定」や、裏側で動いている「検索」の仕組みには、実はRAGの性能を左右する重要な技術が詰まっています。

このコラムでは、Work3では詳しく触れなかったRAGの2つの心臓部、**「チャンク化（文書の分割）」**と**「検索アルゴリズム」**について深掘りします。これらの仕組みを理解することで、なぜDifyがあのように賢く振る舞えるのかが分かり、将来的により精度の高いアプリケーションを自分で調整できるようになります。

---

### 1. AIが文書を読みやすくするための下準備：「チャンク化」とは？ 🧩

RAGが長い文書を扱える秘訣は、文書を丸ごとAIに渡すのではなく、**関連する部分だけを抜き出して渡す**点にあります。そのために、ナレッジを登録する際に、あらかじめ文書を扱いやすいサイズに分割しておく必要があります。この分割処理を「**チャンク化（Chunking）**」と呼びます。

大きな一枚のステーキを、食べやすいように一口サイズに切り分けておくイメージです。AIも同様に、分割された「チャンク」単位で情報を扱うことで、効率的に内容を理解し、検索できるようになります。

Difyのナレッジ設定では、このチャンク化の方法を細かく調整できます。

* **チャンク識別子**: 文書をどこで区切るかのルールです。「\n\n」（空行）などを指定すると、段落ごとにチャンクが作られます。
* **最大チャンク長**: 1つのチャンクに含める最大の文字数（正確にはトークン数）です。チャンクが長すぎると無駄な情報が増え、短すぎると文脈が失われます。Microsoftの報告では512トークンが効果的とされていますが、文書の内容によって調整が必要です。
* **チャンクのオーバーラップ**: チャンクとチャンクの間で、文章を少しだけ重複させる設定です。これにより、文章の切れ目で重要な情報が分断されてしまうのを防ぎます。Difyではチャンク長の10〜25%程度の重複が推奨されています。

Work3ではこの設定を「汎用」で進めましたが、裏ではこのようなインテリジェントな分割処理が行われていたのです。

---

### 2. 最適な情報を見つけ出す検索技術 🔍

文書をチャンクに分割したら、次はその中からユーザーの質問に最も関連性の高いチャンクを探し出す「検索」のステップに移ります。Difyでは、主に以下の2つの検索手法を組み合わせた高度な検索を行っています。

#### 意味で探す「ベクトル検索」

ベクトル検索は、文章の**キーワードが一致していなくても、意味的な近さで関連情報を見つけ出す**ことができる検索手法です。

例えば、「猫はかわいいです」と「ねこちゃんは愛らしいです」という2つの文章は、使われている単語は違いますが、人間には同じような意味だとわかります。ベクトル検索は、**埋め込みモデル（Embedding Model）**という別のAIを使って、文章を「意味」を保持した数値の配列（ベクトル）に変換します。これにより、単語レベルではなく、文脈やニュアンスといった「意味の近さ」でチャンクを検索できるのです。

ただし、この方法は「AC2301B」のような特定の型番など、厳密なキーワード一致が求められる検索には弱いという弱点があります。

#### キーワードで探す「全文検索」

全文検索は、私たちが普段使う検索エンジンのように、**文章に含まれる単語そのもの**を手がかりに検索する古典的ですが強力な手法です。

先ほどのエアコンの型番の例 `AC2301B` のように、意味は似ていても厳密なキーワードで区別する必要がある場合に非常に有効です。ベクトル検索の弱点を補う役割を果たします。

#### 最強の組み合わせ「ハイブリッド検索」🤝

現在のRAGで最も主流なのが、この**ベクトル検索と全文検索を組み合わせた「ハイブリッド検索」**です。

* **ベクトル検索**で、質問の意図や文脈に合ったチャンクを大まかに見つけ出す。
* **全文検索**で、特定のキーワードや固有名詞が含まれるチャンクを正確に見つけ出す。

この2つのアプローチを組み合わせることで、意味の近さとキーワードの一致度を両方考慮した、非常に精度の高い検索が実現します。

Difyのナレッジ設定で「検索設定」を「ハイブリッド検索」にすると、この両方の長所を活かした検索が可能になります。

---

このように、Difyの裏側では、文書をインテリジェントに分割し、複数の高度な検索アルゴリズムを駆使して、最適な情報をAIに届けるという一連の処理が自動的に行われています。

これらの仕組みを少し知っておくだけで、Difyの挙動への理解が深まり、今後のより高度なアプリケーション開発に必ず役立つはずです。

---

### 【小コラム2】あなたの業務にもRAGを！具体的な活用シーン2選

Work3でRAGアプリケーションの作り方を学び、前のコラムでその裏側の仕組みを知りました。では、この強力なRAG技術を、私たちは具体的にどのような業務に活かすことができるのでしょうか？

RAGの本質は、**「特定の文書や情報を参照しながら、回答や文章を生成する必要がある業務」を自動化・効率化できる**点にあります。あなたの普段の仕事の中で「あれ、あの資料どこだっけ…」「この件、前どうやったかな…」と調べ物をする時間はありませんか？そのような作業は、RAGで置き換えられる可能性があります。

ここでは、代表的な2つの活用シーンをご紹介します。

### 1. ヘルプデスク・QA対応の自動化 🙋‍♀️

顧客や社内の他部門からの問い合わせ対応は、RAGが最も輝くシーンの一つです。

* **活用例**:
    * 社内の経理や情報システム部門への定型的な質問（例：「経費精算の締め日はいつですか？」）に、社内規定を参照して24時間365日自動で回答する。
    * 製品やサービスに関する顧客からの質問に、オンラインマニュアルやFAQデータベースを基に回答するカスタマーサポートボットを構築する。

すでに社内にFAQ集やマニュアルが整備されていれば、それをDifyのナレッジに登録するだけで、すぐにでも導入を始められる手軽さも魅力です。

### 2. 大量の社内文書からの情報調査 📂

日々の業務で蓄積される提案書、議事録、技術報告書といった「埋もれた資産」を瞬時に探し出し、活用することができます。

* **活用例**:
    * 営業担当者が、過去の類似案件の提案書を検索し、今回の提案に活かすためのヒントを得る。
    * 開発エンジニアが、膨大な技術仕様書の中から特定の機能に関する記述を素早く見つけ出す。

これまで担当者の記憶や手作業でのファイル検索に頼っていた業務が、RAGによって劇的に高速化・高精度化します。

---

このように、RAGの活用範囲は多岐にわたります。まずはご自身の業務を振り返り、「何かを調べながら、考えながら」行っている作業がないか、ぜひ探してみてください。そこに、RAGが活躍する大きなチャンスが眠っています。