---
seq: 16
title: エージェントノードの基本と2つのアプローチで作る対話型アシスタント
slug: chapter03/work13
description: エージェントノードの基本概念を網羅的に学習し、宣言的アプローチと逐次的アプローチの違いを理解する
type: work
difficulty: 2
displayLanguage: ja
duration: 20
relation: chapter03/index
---

# エージェントノードの基本と2つのアプローチで作る対話型アシスタント

この第8章では、AI自身が次に何をすべきかを判断し、自律的に行動する「**AIエージェント**」の構築に挑戦します。
この最初のワークでは、エージェントノードの基本概念を網羅的に学習すると同時に、**「宣言的アプローチ」**と**「逐次的アプローチ」**という大きく分けて2つの設計思想を、具体的な対話型アシスタントの構築を通じて実践的に学び、その違いを明確に理解します。


## エージェントノードの基本を理解しよう

アプリケーション作成を始める前に、エージェントノードの基本的な考え方を学びましょう。

### エージェントノードとは？ なぜ必要なのか？

エージェントノードとは、一言で言うと**「自分で考えて、道具（ツール）を使い分けるAI」**です。

これまでのチャットフローやワークフローでも、LLMノードやツールを複雑に組み合わせれば、ユーザーの意図に応じて処理を変えることは可能でした。しかし、その場合、「もしユーザーがAと言ったら、Bの処理を実行する」といったルールを、私たち人間が**すべて事前に設計**する必要がありました。これでは、想定されるパターンが増えるほど、フローの設計が指数関数的に複雑になってしまいます。

エージェントノードは、この**「どのツールを、どの順番で使うか」という判断そのものをAIに委ねる**ことで、この複雑さの問題を解決します。私たちはAIに対して、細かい手順を指示する代わりに、「達成してほしい目標」と「使える道具リスト」を与えるだけでよくなります。これにより、より柔軟で、拡張性の高いAIアプリケーションを、はるかにシンプルに構築できるのです。

### エージェントを制御する2つのアプローチ

エージェントの思考を導くプロンプトの設計には、大きく分けて2つのアプローチがあります。これらはプログラミングの世界でも用いられる設計思想であり、どちらが優れているわけではなく、タスクの性質に応じて使い分けることが重要です。

* **宣言的アプローチ (Declarative Approach)**:
    「**何を(What)**」達成したいかというゴールを提示し、具体的な方法はAIの判断に委ねる方式です。状況に応じて柔軟な対応が求められる場合に非常に強力です。
* **逐次的アプローチ (Imperative Approach)**:
    「**どのように(How)**」をステップバイステップで細かく指示する方式です。AIの動作を厳密に制御したい、固定的なプロセスに適しており、予測可能性が高いという利点があります。

## エージェントの思考エンジン：推論戦略

エージェントが「どのように考えて」ツールを選択するのか、その思考プロセスの核となるのが**「推論戦略（Agentic Strategies）」**です。Difyでは、公式プラグインとして主に2つの戦略が用意されています。

* **Function Calling**:
    ユーザーの意図を解析し、実行すべきツールを**直接呼び出す**効率的な戦略です。「東京の天気は？」→ `get_weather("東京")` のように、明確なタスクに向いています。
* **ReAct**:
    「**推論(Reason)**」と「**行動(Act)**」を交互に繰り返し、複雑な問題を段階的に解決していく、より人間に近い思考戦略です。
* ※本講座では、多くの環境で安定して動作する**Function Calling**を中心に実践します。


## **事前準備：推論戦略プラグインのインストール**

1.  Difyのトップページ上部にある `[プラグイン]` をクリックします。
2.  検索窓に「`Dify Agent Strategies`」と入力し、表示されたプラグインの `[インストール]` ボタンをクリックします。

これで、エージェントノードが `Function Calling` や `ReAct` といった思考戦略を利用できるようになりました。


### パートA：宣言的アプローチの実践 - パーソナライズ不動産検索アシスタント

**このパートで挑戦する課題：不動産事業部　滝田さんからの依頼**
-   「AIアバターにお客様対応を任せたい。AIには**『お客様の理想に近い物件を見つける』という最終ゴールを達成するために、自ら考えて行動してほしい**。」

**解説：宣言的アプローチによる自律的ヒアリングと記憶**
この依頼は、AIに「まず名前を聞いて、次に希望エリアを聞いて…」という細かい手順を指示するのではなく、「理想に近い物件を見つける」という**ゴール**を与え、そこに至るまでのヒアリングプロセスはAIの判断に委ねる**「宣言的アプローチ」**の好例です。AIが自ら対話の主導権を握り、より自律的に動作します。
さらに、お客様のお名前を記憶するために**「会話変数」**を活用し、パーソナライズされた対話を実現します。

**ステップ**:
1.  **会話変数の設定**:
    * 新しいチャットフローを作成し、画面右上にあるボタンから会話変数の設定画面を開いて`変数を追加する`をクリックし `user_name` を追加します。種類は`String`、デフォルト値は空のままでOKです。
2.  **宣言的エージェントの構築**:
    * フローの後半に**エージェントノード**を配置し、ツールとして`Web Search`を与えます。
    * **Instructionプロンプト**に、逐次的な「行動計画」ではなく、達成すべき「ゴール」と「役割」を宣言します。

```markdown

# 役割
あなたは、お客様一人ひとりに寄り添う、プロフェッショナルな不動産エージェントです。お客様の名前は「{/user_name}」さんですが、値が空なら尋ねてください。常にお名前で呼びかけ、パーソナライズされた応対を心がけてください。

# 最終目標
あなたの最終目標は、お客様との自由な対話を通じて潜在的なニーズまで汲み取り、理想に近い物件を提案することです。

# 必要な情報
最適な提案を行うためには、お客様から少なくとも以下の情報を自然な会話の中でヒアリングする必要があります。
- 希望のエリア
- 家賃の上限予算
- 希望の間取り
- その他のこだわり条件

# 行動の許可
必要な情報が揃ったとあなたが判断した時点で、`Web Search`ツールを駆使して物件を探し、お客様に提案してください。会話の進め方や質問の順番は、すべてあなたに一任します。

```

4.  **動作確認**:
    * AIが対話を主導し、自然な流れでヒアリングから検索までを実行できることを確認します。


### パートB：逐次的アプローチの実践 - 堂本さんの対話型記事作成アシスタント

**このパートで挑戦する課題：広報マーケティング部 堂本さんのお悩み**
-   「AIと対話しながら、**Web検索の結果を私の目で確認し、OKなら執筆へ、NGなら再検索**というように、ステップごとに人間が承認しながら記事を完成させたい。」

**解説：逐次的アプローチによる、人間の承認を挟む対話フロー**
堂本さんの要望は、「検索→確認→執筆→確認→修正→完成」という、人間の承認を挟む**明確な手順(How)**が存在します。このプロセスをAIに忠実に実行させるためには、AIに具体的な行動計画をステップバイステップで指示する**「逐次的アプローチ」**が非常に有効です。エージェントは、定められた手順に従ってユーザーと対話し、各ステップで承認を求めます。

**ステップ**:
1.  **ツールの準備**:
    * Web検索用に`Tavily`ツールと、最終的な原稿をWordファイルで出力するための`DOC`ツールをマーケットプレイスからインストールしておきます。
2.  **対話型エージェントの構築**:
    * 新しい**チャットフロー**を作成し、**エージェントノードを一つだけ**配置します。
    * **ツール**として、Dify標準の`Tavily`と、先ほど作成した`DOC`を設定します。
3.  **Instructionプロンプトの設計**:
    * エージェントに、記事作成のための具体的な行動計画を、逐次的に指示します。

```markdown

#指示
あなたはプロのライターアシスタントです。ユーザーとの対話を通じて、高品質な記事を執筆するというゴールを達成するため、以下の行動計画に厳密に従ってください。

#基本の行動計画
1.  検索: まず、ユーザーから与えられたテーマについて、`Tavily`ツールを使ってWeb上の情報を検索してください。検索結果を要約してユーザーに提示し、「この内容で執筆に進みますか？」と確認してください。
2.  執筆: ユーザーから承認を得たら、検索結果を基に記事のドラフトを作成し、提示してください。そして、「修正点はありますか？」と確認してください。
3.  修正: ユーザーから修正指示があれば、それに従ってドラフトを修正し、再度提示してください。この修正プロセスはユーザーが満足するまで繰り返してください。
4.  完成: ユーザーから完成の承認を得たら、最終的な記事を`DOC`ツールを使ってDOCXファイルに変換し、成果物として提出してください。

#例外処理
もしユーザーが検索結果に不満を示した場合、キーワードを再設定して検索をやり直してください。
```

4.  **動作確認**:
    * ユーザーとして対話し、エージェントが「検索→確認→執筆…」のサイクルを自律的に進行管理することを確認します。

お疲れ様でした！このワークを通じて、エージェントノードの基本と、それを制御するための2つの重要なアプローチをマスターしました。
この基本を元に次のワークでは、さらに異なるビジネスシナリオでエージェントの能力を引き出していきます。
