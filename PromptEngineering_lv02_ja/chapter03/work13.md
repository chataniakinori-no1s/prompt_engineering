---
seq: 16
title: エージェントノードの基本と2つのアプローチで作る対話型アシスタント
slug: chapter03/work13
description: エージェントノードの基本概念を網羅的に学習し、宣言的アプローチと逐次的アプローチの違いを理解する
type: work
difficulty: 2
displayLanguage: ja
duration: 20
relation: chapter03/index
---

# エージェントノードの基本と2つのアプローチで作る対話型アシスタント

## 今回のお悩み：プロジェクトマネージャー 田中さん
> Difyって、様々なノードを組み合わせることで欲しいアプリケーションをローコード/ノーコードで構築できるって聞いていたんですが、ユーザーの質問に柔軟に対応するには使うブロックやツールが増えますよね。そうなるとノード間で値の渡し方にも制約が増えてくるし、慣れていないと構築に時間が掛かるんですよ。構築やユーザー対応をもう少し柔軟にAIに任せるようなことはできないでしょうか？

これまであなたはDifyのチャットフローやワークフローを一生懸命構築してきましたが、田中さんから上記のような意見をもらいました。AI自身が次に何をすべきかを判断し、目標に向かって自律的に行動してくれる、そんなノードがDifyには存在します。

第8章では、与えられた目標や指示に沿ってAI自身が次に何をすべきかを判断し、自律的に行動する「**エージェントノード**」を組み込んだフローの構築に挑戦します。

この最初のワークでは、エージェントノードの基本概念を網羅的に学習すると同時に、**「宣言的アプローチ」**と**「逐次的アプローチ」**という大きく分けて2つの設計思想を、具体的な対話型アシスタントの構築を通じて実践的に学び、その違いを明確に理解しましょう。


## エージェントノードの基本を理解しよう

アプリケーション作成を始める前に、エージェントノードの基本的な考え方を学びましょう。

### エージェントノードとは？ なぜ必要なのか？

エージェントノードとは、一言で言うと **「自分で考えて、道具（ツール）を使い分けるAI」** です。

これまでのチャットフローやワークフローでも、LLMノードやツールを組み合わせることで、ユーザーの意図に応じて処理を変えることは可能でした。しかし、その場合、「もしユーザーがAと言ったら、Bの処理を実行する」といったルールを、私たち人間が**すべて事前に設計**する必要がありました。これでは、想定されるパターンが増えるほど、フローの設計がどんどん複雑になってしまいます。

エージェントノードは、この **「どのツールを、どの順番で使うか」という判断そのものをAIに委ねる** ことで、この複雑さの問題を解消します。私たちはAIに対して細かい手順を指示しなくても、「達成してほしい目標」と「使える道具リスト」を与えるだけでよくなります。これにより、より柔軟で拡張性の高いAIアプリケーションをはるかにシンプルに構築できるのです。

### エージェントを制御する2つのアプローチ

エージェントの思考を導くプロンプトの設計には、大きく分けて2つのアプローチがあります。これらはプログラミングの世界でも用いられる設計思想であり、どちらが優れているわけではなく、使用場面に応じて使い分けることが重要です。

* **宣言的アプローチ (Declarative Approach)**:
    「**何を(What)**」達成したいかというゴールを提示し、具体的な方法はAIの判断に委ねる方式です。状況に応じて柔軟な対応が求められる場合に有効な方法です。
* **逐次的アプローチ (Imperative Approach)**:
    「**どのように(How)**」をステップバイステップで細かく指示する方式です。AIの動作を厳密に制御したい、固定的なプロセスに適しており、予測可能性が高いという利点があります。

## エージェントの思考エンジン：推論戦略

エージェントが「どのように考えて」ツールを選択するのか、その思考プロセスの核となるのが**「推論戦略（Agentic Strategies）」**です。Difyでは、公式プラグインとして主に2つの戦略が用意されています。

* **Function Calling**:
    ユーザーの意図を解析し、実行すべきツールを**直接呼び出す**効率的な戦略です。「東京の天気は？」→ `get_weather("東京")` のように、明確なタスクに向いています。
* **ReAct**:
    「**推論(Reason)**」と「**行動(Act)**」を交互に繰り返し、複雑な問題を段階的に解決していく、より人間に近い思考戦略です。


## **事前準備：推論戦略プラグインのインストール**

1.  Difyのトップページ上部にある `[プラグイン]` をクリックします。
2.  検索窓に「`Dify Agent Strategies`」と入力し、表示されたプラグインの `[インストール]` ボタンをクリックします。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-1.png)

これで、エージェントノードが `Function Calling` や `ReAct` といった思考戦略を利用できるようになりました。


### パートA：宣言的アプローチの実践 - パーソナライズ不動産検索アシスタント

**このパートで挑戦する課題：不動産事業部　滝田さんからの依頼**
-   「店頭にモニターを置いてAIアバターにお客様対応を任せたいと思っているんです。AIには**いくつかお客様の要望を訊いてもらって、お客様の理想に近い物件を検索して提案するというゴールまで、お客様の問いかけに柔軟に対応しながら行動してほしい**。」

#### **解説：宣言的アプローチによる自律的ヒアリングと記憶**
この依頼は、AIに「まず名前を聞いて、次に希望エリアを聞いて…」という細かい手順を指示するのではなく、「ユーザーの理想に近い物件を見つける」という**ゴール**を与え、そこに至るまでのヒアリングプロセスはAIの判断に委ねる**「宣言的アプローチ」**の好例です。AIが自ら対話の主導権を握り、より自律的に動作します。
さらに、ユーザーの名前を記憶するためにDifyのチャットフローでのみ使える**「会話変数」**を活用し、パーソナライズされた対話を実現してみましょう。

### Step 1: **会話変数の設定**
1. スタジオから新しいチャットフローを作成します。

2. 画面右上にあるボタンから会話変数の設定画面を開いて`+変数を追加`をクリックし `user_name` を追加します。種類は`String`、デフォルト値は空のままでOKです。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-2.png)
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-3.png)

### Step 2: **チャットフローの構築**
1. デフォルトで設置されている`LLM`ノードの右上にある3点マークをクリックし、`ノード変更`をクリック、`エージェント`を選択します。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-4.png)
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-5.png)

2. `エージェント`ノードをクリックし、エージェンティック戦略で「Agent」→「Function Calling」を選択します。

※本講座では、本テキストの執筆時点（2025年9月）で安定して動作する**Function Calling**を中心に使用します。

![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-6.png)

3. MODELは任意のモデルを選択します。

4. 今回はユーザーから訊き出した要望をもとにWeb検索するため、TOOL LISTの横にある`+`をクリックして`Tavily Search`を選択します。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-7.png)

認証されたAPIキーを選択することも忘れずに行いましょう。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-8.png)

5. **Instructionプロンプト**に、達成すべき「ゴール」と「役割」を指示します。

```markdown
# 役割
あなたは、お客様一人ひとりに寄り添う、プロフェッショナルな不動産エージェントです。お客様の名前は「/user_name」さんですが、値が空なら尋ねてください。常にお名前で呼びかけ、パーソナライズされた応対を心がけてください。

# 最終目標
あなたの最終目標は、お客様との自由な対話を通じて潜在的なニーズまで汲み取り、理想に近い物件を提案することです。

# 必要な情報
最適な提案を行うためには、お客様から少なくとも以下の情報を自然な会話の中でヒアリングする必要があります。
- 希望のエリア
- 家賃の上限予算
- 希望の間取り
- その他のこだわり条件

# 行動の許可
必要な情報が揃ったとあなたが判断した時点で、Web検索ツールを駆使して物件を探し、お客様に提案してください。会話の進め方や質問の順番は、すべてあなたに一任します。
```
`/user_name`は会話変数で設定した変数を選択しましょう。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-9.png)


6. QUERYには、以下を設定します。ユーザーの入力内容を覚えてもらうため、メモリもオンにしておきます。
```
#ユーザーの質問
{開始/sys.query}
```
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-10.png)

7. `開始`ノード、`エージェント`ノード、`回答`ノードを接続します。

`回答`ノードの応答で受け取る変数は、`エージェント`ノードの出力変数である{エージェント/text}を設定します。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-11.png)

### Step 3: **チャットフローの動作確認**

プレビューボタンをクリックして、`海が見える家を探しているんだけど...`と質問してみましょう。
AIが対話を主導し、自然な流れでヒアリングから検索までを実行できることを確認します。


### パートB：逐次的アプローチの実践 - 堂本さんの対話型記事作成アシスタント

**このパートで挑戦する課題：広報マーケティング部 堂本さんのお悩み**
>「この前はSEO記事作成のワークフローをどうもありがとう。ただ実際に使ってみるとAIの出力に粗があるというか……検索結果や執筆&修正結果が出るたびに確認して、私の方でも修正依頼を出したいんだ。記事のメモを渡してAIと対話しながら、**Web検索や執筆の結果を私の目で確認し、OKなら次のステップ、NGなら再実行**というように、ステップごとに人間が承認しながら記事を完成させたいんだけど、できるかな？」

#### **解説：逐次的アプローチによる、人間の承認を挟む対話フロー**

堂本さんの要望は、「検索→確認→執筆→確認→修正→完成」という、人間の承認を挟む**明確な手順(How)**が存在します。
改めて6章の実践課題で構築したワークフローの全体像を思い返してみましょう。
```
    1. 渡した記事のメモファイルをもとに記事をWeb検索
    2. 記事のメモファイルと検索した記事をもとに、記事の構成案を検討
    3. 上記情報をもとに執筆、修正
    4. 最終的に出来上がった記事をDOCXファイルで出力
```
もちろんエージェントノードを使わずにチャットフローで構築も可能ですが、以下画像のように利用するノードが増え、複数パターンの導線が必要になります。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-12.png)

この複雑なチャットフローも、エージェントノードを使うことで簡単に再現が可能です。ただし忠実に実行させるためには、AIに具体的な行動計画をステップバイステップで指示する **「逐次的アプローチ」** を用います。定められた手順に従ってユーザーと対話し、各ステップで承認を求めるようなチャットフローを構築していきましょう。

### Step 1: **ツールの準備**
1. Web検索用に`Tavily`ツールと、最終的な原稿をWordファイルで出力するための`DOC`ツールをマーケットプレイスからインストールしておきます。
### Step 2: **チャットフローの構築**
1. スタジオから新しいチャットフローを作成します。

2. `開始`ノードをクリックし、入力フィールドにファイルアップロード用の変数を設定します。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-13.png)

3. デフォルトで設置されている`LLM`ノードの右上にある3点マークをクリックし、`ノード変更`をクリック、`エージェント`を選択します。

4. `エージェント`ノードをクリックし、エージェンティック戦略で「Agent」→「Function Calling」を選択します。※本講座では、本テキストの執筆時点（2025年9月）で安定して動作する**Function Calling**を中心に使用します。

5. MODELは任意のモデルを選択します。

6. TOOL LISTの横にある`+`をクリックして`Tavily Search`と`DOC`を選択します。

![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-14.png)

Tavily Searchツールは認証されたAPIキーを選択することも忘れずに行いましょう。

7. **Instructionプロンプト**に、達成すべき「ゴール」と「役割」を指示します。

```markdown
#指示
あなたはプロのライターアシスタントです。ユーザーとの対話を通じて、高品質な記事を執筆するというゴールを達成するため、以下の行動計画に厳密に従ってください。

#基本の行動計画
1.  検索: まず、ユーザーから与えられたテーマについて、`Tavily`ツールを使ってWeb上の情報を検索してください。検索結果を要約してユーザーに提示し、「この内容で執筆に進みますか？」と確認してください。
2.  執筆: ユーザーから承認を得たら、検索結果を基に記事のドラフトを作成し、提示してください。そして、「修正点はありますか？」と確認してください。
3.  修正: ユーザーから修正指示があれば、それに従ってドラフトを修正し、再度提示してください。この修正プロセスはユーザーが満足するまで繰り返してください。
4.  完成: ユーザーから完成の承認を得たら、最終的な記事を`DOC`ツールを使ってDOCXファイルに変換し、成果物として提出してください。
```

8. テキスト抽出ノードを`開始`ノードと`エージェント`ノードの間に設置します。
記事のメモファイルはそのまま`エージェント`ノードに渡せないため、テキスト抽出してから渡します。

`テキスト抽出`ノードをクリックし、入力変数に`{開始/requirements_doc}`を設定します。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-15.png)

9. QUERYには、以下を設定します。ユーザーの入力内容を覚えてもらうため、メモリもオンにしておきます。
```
#ユーザーの質問
{開始/sys.query}
#記事のメモ
{テキスト抽出/text}
```
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter03/img/work13-16.png)

10. `エージェント`ノードと`回答`ノードを接続します。

`回答`ノードの応答で受け取る変数は、`エージェント`ノードの出力変数である{エージェント/text}を設定します。

### Step 3: **チャットフローの動作確認**
ユーザーとして対話し、エージェントが「検索→確認→執筆…」のサイクルを自律的に進行管理し、最終的にDOCXファイルで記事を出力してくれることを確認します。


お疲れ様でした！このワークを通じて、エージェントノードの基本と、それをプロンプトで制御するための2つの重要なアプローチを学びました。
次のワークでは、さらに異なるビジネスシナリオでエージェントの能力を引き出していきます。
