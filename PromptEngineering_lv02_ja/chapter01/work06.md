---
seq: 7
title: 条件分岐による対話制御とコスト最適化
slug: chapter01/work06
description: ユーザーの入力に応じた条件分岐を実装し、AIの応答を最適化する方法を学ぶ
type: work
difficulty: 3
displayLanguage: ja
duration: 10
---

# 条件分岐による対話制御とコスト最適化

前回のワークで作成したチャットボットは、登録された文書（ナレッジベース）の中からその質問に最も関連性の高い部分を検索して、回答生成することが可能になりました。
しかし、塚本さんが実際に運用してみると、新たな課題として「コスト」の側面が見えてきました。

**【新たな依頼：管理部 塚本さん】**
> 「社内の問い合わせに対してチャットボットが一次対応してくれるようになって、大変助かっています！ただフローを見ていると、社員が無関係な質問をしても社内文書の検索結果をプロンプトに入れてしまったり、長文の回答をしているんです。これは無駄なコスト（トークン）がかかっていませんか？
> たとえば雑談や挨拶など無関係な話題の時はナレッジ検索をせず短く回答して、本当に情報が必要な時だけ検索するようにできませんか？」

この課題を解決するために、**ユーザーの意図に応じて処理の流れを分岐させる「条件分岐」**の技術を学びます。これにより、AIの挙動をより精密に制御し、不要な処理をなくしてコスト効率の高いアプリケーションを構築します。

---

### 実践：コスト効率と対話性能を両立したFAQボットへの改良

作成するアプリケーションの全体像は以下のようになります。
1.  ユーザーの質問が「社内規定に関する質問」なのか「それ以外」かをAIが分類する。
2.  「社内規定に関する質問」の場合のみ、ナレッジを検索し、その結果を基に回答を生成する。
3.  「それ以外」の場合は、ナレッジ検索を行わず、シンプルな応答を返すことでコストを最小限に抑える。

それでは、ワーク3で作成した育児休業規定ボットをベースに、この新しい機能を追加していきましょう。

#### Step 1: ユーザーの意図を分類する (質問分類器の追加)

1.  ワーク3で作成した育児休業規定ボットを開きます。
2.  `開始` ノードと`知識検索`ノードの間にカーソルをあわせて `+` ボタンを押し、`[質問分類器]`ノードを追加します。これにより、不要なナレッジ検索を実行しないルートを構築し、コストを削減します。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter01/img/work6-1.png)
3.  **質問分類器ノードの設定**:
    * `入力変数` に `sys.query` が設定されていることを確認します。
    * `クラス` の設定で、以下の2つの分類を作成します。
        * `クラス1`: `育児休業規定に関する質問`
        * `クラス2`: `その他`
      ![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter01/img/work6-2.png)
    * `高度な設定` を開き、`メモリ` のトグルをONにします。（ワーク2で学んだ通り、分類時にも過去の会話を考慮させるためです）

4.  **【プロンプト応用】分類精度を高めるための指示**
    `高度な設定`を開いて`指示`の入力欄に、Few-Shot（少数例示）を応用したプロンプトを記述し、分類精度を高めます。
    ``` ユーザーの質問を以下のクラスに分類してください。会話の文脈も考慮して、最も適切なクラスを一つだけ選択してください。

    # クラス定義と判断例
    ## 育児休業規定に関する質問
    ユーザーが会社の育児休業制度について質問している場合に選択します。
    例:
    - 「育休制度について教えて」
    - 「取得中の労働に制限は？」
    - 「それの申請手続きは？」

    ## その他
    上記に当てはまらない、挨拶、雑談、感謝などの一般的な会話の場合に選択します。
    例:
    - 「こんにちは」
    - 「ありがとう！」
    - 「今日の天気は？」
    ```
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter01/img/work6-3.png)

5.  **ノードの接続**
	* `質問分類器`ノードの　`クラス1` 横にある `+` をクリックし、ドラッグしながら`知識検索`ノードと接続します。これで、質問内容がクラス1に分類された場合は知識検索ノードへ処理が進むようになります。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter01/img/work6-4.png)

#### Step 2: クラス2に進んだ場合のノード追加と出力の集約

1.  **挨拶への応答**: `質問分類器` の `クラス2` の分岐から、別の `LLM` ノード（`挨拶LLM`）を追加し、「短くシンプルな返答をしてください。」といったプロンプトとメモリ設定を行います。
![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter01/img/work6-5.png)

2.  **`変数集約器`ノードの追加と設定**:
    最後に、2つの異なるルート（RAG回答ルートとその他ルート）からどちらの出力結果が来ても`回答`ノードに渡せるよう、処理を追加します。
	* Step1の`LLM`ノードと、このステップの`LLM2`の次に、`[変数集約器]`ノードを配置します。
   ![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter01/img/work6-6.png)
    * ノードの設定を開き、「変数を代入する」の右にある`+`をクリックして各LLMノードの出力結果を代入します。（例: `LLM_text` と `LLM2_text`）
    ![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter01/img/work6-7.png)
3.  **`回答`ノードへの接続**: `変数集約器`の出力（例：`output`）を、最後の`回答`ノードに接続します。これにより、どちらか一方のルートから渡された有効な変数をまとめて、後続のノードに渡すことができます。
    ![](https://chataniakinori-no1s.github.io/prompt_engineering/PromptEngineering_lv02_ja/assets/chapter01/img/work6-8.png)

:::POINT
**【解説】なぜ`変数集約器`が必要なのか？**
> `回答`ノードは、チャットの応答を逐次表示（ストリーミング）する機能を持っています。しかし、複数のLLMから直接接続すると、どの接続を優先してストリーミングすべきか混乱し、意図しないルートの出力が表示されたり、何も表示されなかったりする場合があります。
> `変数集約器`を間に挟むことで、**複数のルートからの出力を、単一の安定した変数（データストリーム）に統合**できます。これにより、`回答`ノードは常に一つの入力元だけを見ればよくなり、どちらのルートが実行されても、その結果を確実かつ安定してユーザーに表示できるようになります。これは、複雑な分岐を持つアプリケーションを堅牢にするための重要なテクニックです。
:::

#### Step 3: 動作確認

すべての設定が完了したら、プレビュー画面で動作を確認しましょう。

1. `「明日の天気は？」`と入力 → ナレッジ検索が実行されないルートへ処理が進んでいることを確認。
2. `「育児休業について教えて」` →知識検索して回答を生成していることを確認。

お疲れ様でした！ 
このワークでは、条件分岐を活用してAIチャットボットの効率を向上させる方法を学びました。ユーザーの入力に応じて適切な処理を選択することで、コストを削減しつつ、ユーザーエクスペリエンスを向上させることができます。

次回は、この第6章で学んだ内容の総復習として、実践課題に挑戦します。業務で使える顧客対応AIチャットボットを作成していきましょう。
