---
seq: 4
title: RAG（検索拡張生成）でAIを賢くしよう
slug: chapter01/work03
description: RAG技術を活用して、社内文書を参照できるAIチャットボットを構築する
type: work
difficulty: 3
displayLanguage: ja
duration: 30
---

# RAG（検索拡張生成）でAIを賢くしよう

Work2では、Difyの基本的な操作を学び、AIに特定の役割を与えるチャットボットを作成しました。しかし、そのAIはあなたの会社のルールや、特定の業務マニュアルの内容までは知りません。このままでは、冒頭の塚本さんの課題「社内情報に詳しいFAQボットが欲しい」を解決することはできません。

この課題を解決する鍵が、**RAG（Retrieval-Augmented Generation：検索拡張生成）**という技術です。このワークでは、RAGの仕組みを学び、Difyを使って社内文書の内容を正確に回答できるAIチャットボットを構築します。

## RAG（検索拡張生成）とは？

#### なぜRAGが注目されているのか

ChatGPTのような一般的なLLMは、事前に学習した膨大なデータをもとに回答しますが、**学習データに含まれない情報（最新のニュースや、あなたの会社独自のルールなど）は知りません**。

これまで、この制約に対処するために「プロンプトに参考情報をすべて貼り付ける」という方法がありましたが、これには以下のような問題がありました。
* 毎回ファイルをアップロードするのは手間がかかる。
* プロンプトが長くなり、利用コストが増大する。
* LLMが一度に処理できる文字数（トークン数）には上限がある。

**RAG**は、これらの問題を解決する画期的な技術です。事前に社内文書などをシステムに登録しておき、ユーザーの質問に応じて**関連する部分だけをAIが参照して回答を生成する**仕組みです。 これにより、コストを抑えつつ、膨大な独自情報に基づいた正確な回答が可能になります。

#### RAGの基本的な仕組み

RAGの仕組みは、実は私たちの情報検索プロセスとよく似ています。知らないことを質問されたとき、私たちは参考資料やGoogleで関連情報を探し、その情報をもとに回答を組み立てますよね。RAGも同様に、以下の2ステップで動作します。

1.  **検索 (Retrieval)**: ユーザーの質問が来たら、まず事前に登録された文書（ナレッジベース）の中から、その質問に最も関連性の高い部分を検索して探し出します。
2.  **生成 (Generation)**: 見つけ出した関連情報と元の質問をLLMに渡し、「この情報に基づいて回答してください」と指示を出して、最終的な回答を生成させます。

この「必要な部分だけを賢く検索して利用する」という点がRAGの核心です。

#### DifyがRAGを簡単にする理由

RAGの裏側では、「埋め込みモデル」による文章の数値化や、「ベクトル検索」といった高度な技術が動いています。 本来、これらを一から実装するのは専門知識が必要で非常に大変ですが、Difyはこれらの複雑な技術をパッケージ化し、**プログラミング不要**で誰でも簡単にRAGアプリケーションを構築できるようにしてくれます。

---

### 実践：育児休業規定に詳しいFAQボットを作る

> **【今回のお悩み：管理部 塚本さん】**
> 「育児休業の規定について、いろいろな社員から細かい質問を何度も受けていて、本来の業務が進まないんです…。『育児休業規定_サンプル.docx』というマニュアルはあるのですが、みんな読んでくれなくて。このPDFの内容を正確に参照して、私の代わりに質問に答えてくれるチャットボットが作れないでしょうか？」

それでは、実際にDifyを使い、塚本さんの悩みを解決するRAGチャットボットを作成していきましょう。

#### Step 1: ナレッジの準備とアップロード

まず、AIに参照させたい「育児休業規定_サンプル.docx」をDifyに「ナレッジ」として登録します。

1.  Difyのトップメニューから `[ナレッジ]` を選択します。
2.  `[ナレッジを作成]` ボタンをクリックします。
3.  `[ファイルのアップロード]` を選択し、AIに学習させたい文書ファイル（例：`育児休業規定_サンプル.docx`）をアップロードします。
4.  `[次へ]` をクリックします。

#### Step 2: テキストの前処理設定

次に、アップロードした文書をAIが検索しやすいように「前処理」します。まずはデフォルト設定のまま進めましょう。

1.  **チャンク処理**: `汎用` が選択されていることを確認します。
2.  **インデックスモード**: `高品質` を選択します。 これにより、文章の意味を理解して検索する「ベクトル検索」の準備が行われます。
3.  `[保存して処理]` をクリックします。処理が完了し、ステータスが「利用可能」になるまで少し待ちます。

これで、AIが文書を検索するための準備が整いました。

#### Step 3: チャットフローの構築とノード設定

次に、RAGの処理フローをチャットフローで組み立てます。

1.  `[スタジオ]` に戻り、`[アプリを作成]` から `[チャットフロー]` を選択し、新しいアプリ（例: `育児休業規定ボット`）を作成します。
2.  今回は1から作るので、デフォルトで配置されている `LLM` ノードと `回答` ノードは一度削除してください。
3.  `開始` ノードの `+` ボタンを押し、`[知識取得]` ノードを追加します。このノードがRAGの「検索」部分を担当します。
4.  **知識取得ノードの設定**:
    * ノードをクリックし、`クエリ変数` に `sys.query` を設定します。これは「ユーザーの質問を手がかりに検索する」という意味です。
    * `ナレッジ` の欄で、先ほど作成したナレッジ（`育児休業規定_サンプル.docx`）を選択します。

5.  `知識取得` ノードの `+` ボタンを押し、`[LLM]` ノードを追加します。これが「生成」部分を担当します。
6.  **LLMノードの設定**:
    * `コンテキスト` の設定欄をクリックし、`知識取得` ノードの出力である `result` を選択します。 これで、検索結果をLLMに渡す準備ができました。
    * **`メモリ` のトグルスイッチをONにします。** これにより、AIは過去の会話を記憶し、「それについてもっと詳しく」といった追跡質問にも対応できるようになります。
    * `システムプロンプト` に、以下のプロンプトを貼り付けます。
        ```
        あなたはGrowthTech社の管理部アシスタントAIです。
        提供された育児休業規定の文書にのみ基づいて、社員からの質問に対し、正確かつ丁寧な言葉遣いで回答してください。

        ### 制約条件
        - 必ず文脈の情報のみを使用して回答すること
        - 文脈に含まれない情報については「規定文書をご確認いただくか、管理部までお問い合わせください」と回答すること
        - 推測や一般的な知識での補完は行わないこと

        ### 文脈
        {{context}}
        ```
    * `ユーザー入力` の欄に、`sys.query` を設定します。これで、ユーザーの質問もLLMに渡されます。

7.  `LLM` ノードの `+` ボタンを押し、最後に `[回答]` ノードを追加します。
8.  **回答ノードの設定**: `回答`ノードをクリックし、設定パネルを開きます。`入力`欄で、前の`LLM`ノードの出力変数（例: `{{#LLM-1.result#}}`）が設定されていることを確認します。

#### Step 4: 動作確認

すべてのノードが繋がったら、プレビュー画面で動作を確認しましょう。

1.  画面右上の `[プレビュー]` をクリックします。
2.  チャット入力欄に、PDFの内容に関する質問をしてみてください。
    * **あなた**: `育児休業は何歳まで取得できますか？`
    * **AIの応答（予想）**: （PDFの内容に基づき）`お子様が1歳に達するまで取得できます。`
3.  続けて、文脈に依存した質問をしてみましょう。
    * **あなた**: `男性も取れますか？`
    * **AIの応答（予想）**: （メモリ機能が働き、育休の話題と理解して）`はい、男性社員も取得可能です。`

ナレッジの内容に基づいてAIが回答し、追跡質問にも答えられれば成功です！

---

お疲れ様でした！ これで、あなただけの知識を持ったAIチャットボットが完成しました。次のWork4では、このチャットボットの課題点を改善する実践的なテクニックを学びます。

---

