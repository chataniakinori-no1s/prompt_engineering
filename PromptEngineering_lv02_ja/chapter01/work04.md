---
seq: 5
title: 【小コラム】RAGの心臓部を探る：AIはどのようにして"賢く"検索しているのか？
slug: chapter01/column01
description: RAG技術の核心であるチャンク化と検索アルゴリズムの仕組みを解説
type: column
difficulty: 3
displayLanguage: ja
duration: 15
---

# RAGの心臓部を探る：AIはどのようにして"賢く"検索しているのか？

先ほどのワークでは、Difyの「知識検索」ノードを使用することで、驚くほど簡単にRAG（検索拡張生成）アプリケーションを構築できることを体験しました。しかし、ナレッジを作成する際に何気なく行った設定や、裏側で動作している検索の仕組みには、実はRAGの性能を左右する重要な技術が詰まっています。

このコラムでは、詳しく触れられなかったRAGの大事な2つの仕組みである**「チャンク化（文書の分割）」**と**「検索アルゴリズム」**について深掘りします。これらの仕組みを理解することで、なぜDifyがあのように賢く振る舞えるのかが分かり、将来的により精度の高いRAGアプリケーションを構築するためのヒントが得られるでしょう。

## チャンク化：文書をどのように分割するかが重要

RAGを構築する第一歩は、元の文書を「チャンク」と呼ばれる小さな断片に分割することです。このチャンク化の方法が、AIの回答品質に大きく影響を与えます。

### 単純なチャンク化の問題点

最も単純な方法は、文書を一定の文字数で区切る方法です。例えば、1000文字ごとに分割するといった具合です。しかし、この方法には以下のような問題が存在します。

文の途中で切れてしまうと、文脈が失われてしまいます。また、重要な情報がチャンクの境目で分断される可能性があります。さらに、長い文書と短い文書でチャンクの質にばらつきが生じてしまいます。これらの問題により、検索精度や回答品質が低下する恐れがあります。

### より賢いチャンク化の手法

Difyを含む多くのRAGシステムでは、より高度なチャンク化の手法が採用されています。

意味的な区切りを考慮した分割では、段落や見出しの境界で分割を行います。これにより、文脈を保ちながら適切な単位で情報を切り分けることができます。オーバーラップを持たせる手法では、チャンク同士で一部重複を持たせることで、文脈の連続性を保ちます。階層的な分割では、大見出し、中見出し、小見出しなどの階層構造を考慮して分割を行い、文書の構造を維持します。

## 検索アルゴリズム：関連性の高い情報を見つけ出す技術

RAGのもう一つの重要な要素が、ユーザーの質問に基づいて関連するチャンクを効率的に見つけ出す検索アルゴリズムです。

### １．全文検索

キーワードを使用して、文書全体からそのキーワードを含むチャンクを直接探し出すのが、最も古典的で直感的な検索手法です。

この手法では、まずインデックス作成の段階で、あらかじめ文書内の単語を抽出し、どの単語がどの文書のどこに出現するかを記録した索引（転置インデックス）を作成します。検索時には、ユーザーが入力したキーワードを元にインデックスを引き、該当する文書を高速に見つけ出します。最後に、キーワードの出現頻度などに基づいて結果を順位付けします。

この手法の長所は、特定のキーワードや固有名詞、専門用語などを正確かつ高速に検索することに長けている点です。一方で短所としては、類義語や言い換え（例：「PC」と「パソコン」）を認識できず、文脈や意味の類似性を考慮した検索ができない点が挙げられます。

### ２．ベクトル検索（セマンティック検索）

2つ目はベクトル検索です。この手法は意味の類似性に基づいて検索を行います。

まず、埋め込み（Embedding）の段階で、テキストをその意味や文脈を捉えた数値のベクトルに変換します。次に類似度計算では、ユーザーの質問を同様にベクトル化し、文書のベクトルとの近さ（類似度）を計算します。そして、類似度が高い順に結果を返すランキングを行います。

この手法の長所は、抽象的な質問や、キーワードが完全一致しない場合でも、意図や文脈に合った関連性の高い情報を見つけ出すことができる点です。しかし短所として、固有名詞や特定のキーワードの検索精度では、全文検索に劣る場合があります。

### ３．ハイブリッド検索

最後に、上記の2つを組み合わせたハイブリッド検索が行われています。それぞれの検索手法の長所を活かし、短所を補い合うことで、より高精度な検索を実現します。

ベクトル検索は、質問の意図や文脈に合ったチャンクを大まかに見つけ出す役割を担います。一方、全文検索は、特定のキーワードや固有名詞が含まれるチャンクを正確に見つけ出し、検索結果の精度を向上させる役割を果たします。この2つの手法を組み合わせることで、意味的な関連性と正確なキーワードマッチングの両方を実現し、より賢い検索が可能になるのです。
