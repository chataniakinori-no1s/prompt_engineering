---
seq: 5
title: 【小コラム】RAGの心臓部を探る：AIはどのようにして"賢く"検索しているのか？
slug: chapter01/column01
description: RAG技術の核心であるチャンク化と検索アルゴリズムの仕組みを解説
type: column
difficulty: 3
displayLanguage: ja
duration: 15
---

# RAGの心臓部を探る：AIはどのようにして"賢く"検索しているのか？

先ほどのワークでは、Difyの「知識検索」ノードを使って、驚くほど簡単にRAG（検索拡張生成）アプリケーションを構築できることを体験しました。しかし、ナレッジを作成する際に何気なく行った設定や、裏側で動いている検索の仕組みには、実はRAGの性能を左右する重要な技術が詰まっています。

このコラムでは、詳しく触れられなかったRAGの大事な2つの仕組み**「チャンク化（文書の分割）」**と**「検索アルゴリズム」**について深掘りします。これらの仕組みを理解することで、なぜDifyがあのように賢く振る舞えるのかが分かり、将来的により精度の高いRAGアプリケーションを構築するためのヒントが得られるでしょう。

## チャンク化：文書をどう分割するかが重要

RAGを構築する第一歩は、元の文書を「チャンク」と呼ばれる小さな断片に分割することです。このチャンク化の仕方が、AIの回答品質に大きく影響します。

### 単純なチャンク化の問題点

最も単純な方法は、文書を一定の文字数で区切る方法です。例えば、1000文字ごとに分割するといった具合です。しかし、この方法には以下のような問題があります：

1. 文の途中で切れてしまうと、文脈が失われる
2. 重要な情報がチャンクの境目で分断される可能性がある
3. 長い文書と短い文書でチャンクの質にばらつきが生じる

### より賢いチャンク化の手法

Difyを含む多くのRAGシステムでは、より高度なチャンク化の手法が採用されています：

- **意味的な区切りを考慮**: 段落や見出しの境界で分割する
- **オーバーラップを持たせる**: チャンク同士で一部重複を持たせ、文脈の連続性を保つ
- **階層的な分割**: 大見出し、中見出し、小見出しなどの階層構造を考慮して分割

## 検索アルゴリズム：関連性の高い情報を見つけ出す技術

RAGのもう一つの重要な要素が、ユーザーの質問に基づいて関連するチャンクを効率的に見つけ出す検索アルゴリズムです。

### 全文検索

キーワードを使って、文書全体からそのキーワードを含むチャンクを直接探し出す、最も古典的で直感的な検索手法です。

1.  **インデックス作成**: あらかじめ文書内の単語を抽出し、どの単語がどの文書のどこに出現するかを記録した索引（転置インデックス）を作成します。
2.  **検索**: ユーザーが入力したキーワードを元にインデックスを引き、該当する文書を高速に見つけ出します。
3.  **ランキング**: キーワードの出現頻度などに基づいて結果を順位付けします。

**特徴**:
* **長所**: 特定のキーワードや固有名詞、専門用語などを正確かつ高速に検索することに長けています。
* **短所**: 類義語や言い換え（例：「PC」と「パソコン」）を認識できず、文脈や意味の類似性を考慮した検索はできません。

---

### ベクトル検索（セマンティック検索）

Difyの「高品質」モードでも中核技術として使用されているのが、このベクトル検索です。意味の類似性に基づいて検索します。

1.  **埋め込み（Embedding）**: テキストを、その意味や文脈を捉えた数値のベクトルに変換します。
2.  **類似度計算**: ユーザーの質問を同様にベクトル化し、文書のベクトルとの近さ（類似度）を計算します。
3.  **ランキング**: 類似度が高い順に結果を返します。

**特徴**:
* **長所**: 抽象的な質問や、キーワードが完全一致しない場合でも、意図や文脈に合った関連性の高い情報を見つけ出すことができます。
* **短所**: 固有名詞や特定のキーワードの検索精度では、全文検索に劣る場合があります。

---

### ハイブリッド検索

Difyの「高品質」モードでは、以下の2つを組み合わせたハイブリッド検索が行われています。それぞれの検索手法の長所を活かし、短所を補い合うことで、より高精度な検索を実現します。

* **ベクトル検索**: 質問の意図や文脈に合ったチャンクを大まかに見つけ出します。
* **全文検索**: 特定のキーワードや固有名詞が含まれるチャンクを正確に見つけ出し、検索結果の精度を向上させます。
